{
    "sourceFile": "scripts/initSetup.sh",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 46,
            "patches": [
                {
                    "date": 1698242128453,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1698242641131,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -131,9 +131,9 @@\n \n \n function configureNginx(){\n     sed -i 's/user  nginx;/user  www-data;/' /etc/nginx/nginx.conf\n-    cp /data/nextcloud.conf /etc/nginx/conf.d/\n+    cp /app/data/nextcloud.conf /etc/nginx/conf.d/\n     if [ -f /etc/nginx/conf.d/default.conf ]; then\n         mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.disabled\n     fi\n     if [ -f /etc/nginx/sites-enabled/default ]; then\n"
                },
                {
                    "date": 1698242666956,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -148,9 +148,9 @@\n     doMsg \"--> Installo Nextcloud\"\n     $occ maintenance:install --database \\\n     \"pgsql\" --database-name \"${NEXTCLOUD_POSTGRES_DB}\"  --database-user \"${NEXTCLOUD_POSTGRES_USER}\" --database-pass \\\n     \"${NEXTCLOUD_POSTGRES_PASSWORD}\" --database-host ${DB_POSTGRES_HOST_IP} --database-port ${DB_POSTGRES_PORT} --admin-user \\\n-    \"${NEXTCLOUD_ADMIN}\" --admin-pass \"${NEXTCLOUD_ADMIN_PASSWORD}\" --data-dir \"/nfs4/www/data\"\n+    \"${NEXTCLOUD_ADMIN}\" --admin-pass \"${NEXTCLOUD_ADMIN_PASSWORD}\"\n \n     \n     chmod +x ${NEXTCLOUD_FOLDER}/occ\n     $occ config:system:set overwriteprotocol --value \"${PROTOCOLWEB}\"\n"
                },
                {
                    "date": 1698243084451,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -62,14 +62,23 @@\n     esac\n }\n \n function installPostgres(){\n-    sh -c 'echo \"deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list'\n-    wget -qO- https://www.postgresql.org/media/keys/ACCC4CF8.asc | tee /etc/apt/trusted.gpg.d/pgdg.asc &>/dev/null\n-    apt-get update\n+    if [ -f /etc/apt/sources.list.d/pgdg.list ]; then\n+        doMsg \"--> La repo di postgres è già presente, non la scarico\"\n+    else\n+        doMsg \"--> Aggiungo la repo di postgres\"\n+        sh -c 'echo \"deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list'\n+        wget -qO- https://www.postgresql.org/media/keys/ACCC4CF8.asc | tee /etc/apt/trusted.gpg.d/pgdg.asc &>/dev/null\n+        apt-get update\n+    fi\n \n-    doMsg \"--> Installo postgresql ${POSTGRES_VERSION}\"\n-    apt-get install postgresql-${POSTGRES_VERSION} postgresql-client-${POSTGRES_VERSION} -y\n+    if [ $(apt list | grep installed | postgresql | wc -l) -gt 0 ]; then\n+        doMsg \"--> Postgresql è già installato\"\n+    else\n+        doMsg \"--> Installo postgresql\"\n+        apt-get install postgresql-${POSTGRES_VERSION} postgresql-client-${POSTGRES_VERSION} -y\n+    fi\n \n     doMsg \"--> Avvio postgresql ${POSTGRES_VERSION}\"\n     systemctl start postgresql\n }\n"
                },
                {
                    "date": 1698243120130,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -96,8 +96,12 @@\n \n function installRedis(){\n     doMsg \"--> Installo redis\"\n     REDISCONFIGFILE=/etc/redis/redis.conf\n+    if [ -f ${REDISCONFIGFILE} ]; then\n+        doMsg \"--> Redis è già installato\"\n+        return\n+    fi\n     apt-get install redis-server -y -qq\n     sed '/#ADDCUSTOM/,$d' ${REDISCONFIGFILE} > ${REDISCONFIGFILE}.new\n     mv ${REDISCONFIGFILE} ${REDISCONFIGFILE}.old\n     mv ${REDISCONFIGFILE}.new ${REDISCONFIGFILE}\n"
                },
                {
                    "date": 1698243144197,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -94,20 +94,21 @@\n END\n }\n \n function installRedis(){\n-    doMsg \"--> Installo redis\"\n     REDISCONFIGFILE=/etc/redis/redis.conf\n     if [ -f ${REDISCONFIGFILE} ]; then\n         doMsg \"--> Redis è già installato\"\n-        return\n+    else\n+        doMsg \"--> Installo redis\"\n+        apt-get install redis-server -y -qq\n+        sed '/#ADDCUSTOM/,$d' ${REDISCONFIGFILE} > ${REDISCONFIGFILE}.new\n+        mv ${REDISCONFIGFILE} ${REDISCONFIGFILE}.old\n+        mv ${REDISCONFIGFILE}.new ${REDISCONFIGFILE}\n+        echo \"#ADDCUSTOM\" >> ${REDISCONFIGFILE}\n+        echo \"bind 127.0.0.1 ::1\" >> ${REDISCONFIGFILE}\n     fi\n-    apt-get install redis-server -y -qq\n-    sed '/#ADDCUSTOM/,$d' ${REDISCONFIGFILE} > ${REDISCONFIGFILE}.new\n-    mv ${REDISCONFIGFILE} ${REDISCONFIGFILE}.old\n-    mv ${REDISCONFIGFILE}.new ${REDISCONFIGFILE}\n-    echo \"#ADDCUSTOM\" >> ${REDISCONFIGFILE}\n-    echo \"bind 127.0.0.1 ::1\" >> ${REDISCONFIGFILE}\n+    \n     systemctl restart redis\n }\n \n function installDep(){\n"
                },
                {
                    "date": 1698243291804,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -144,8 +144,9 @@\n }\n \n \n function configureNginx(){\n+    doMsg \"--> Applico la configurazione di nginx\"\n     sed -i 's/user  nginx;/user  www-data;/' /etc/nginx/nginx.conf\n     cp /app/data/nextcloud.conf /etc/nginx/conf.d/\n     if [ -f /etc/nginx/conf.d/default.conf ]; then\n         mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.disabled\n"
                },
                {
                    "date": 1698243320986,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -156,9 +156,9 @@\n     fi\n }\n \n function configureNextcloud(){\n-    doMsg \"--> Controlla permessi cartella di setup\"\n+    doMsg \"--> Controllo permessi cartella di setup\"\n     chown -R www-data:www-data ${NEXTCLOUD_FOLDER}\n \n     doMsg \"--> Installo Nextcloud\"\n     $occ maintenance:install --database \\\n"
                },
                {
                    "date": 1698243346926,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -156,17 +156,23 @@\n     fi\n }\n \n function configureNextcloud(){\n-    doMsg \"--> Controllo permessi cartella di setup\"\n+    doMsg \"--> Controllo i permessi della cartella di setup\"\n     chown -R www-data:www-data ${NEXTCLOUD_FOLDER}\n \n     doMsg \"--> Installo Nextcloud\"\n     $occ maintenance:install --database \\\n     \"pgsql\" --database-name \"${NEXTCLOUD_POSTGRES_DB}\"  --database-user \"${NEXTCLOUD_POSTGRES_USER}\" --database-pass \\\n     \"${NEXTCLOUD_POSTGRES_PASSWORD}\" --database-host ${DB_POSTGRES_HOST_IP} --database-port ${DB_POSTGRES_PORT} --admin-user \\\n     \"${NEXTCLOUD_ADMIN}\" --admin-pass \"${NEXTCLOUD_ADMIN_PASSWORD}\"\n \n+    if [ $? -eq 0 ]; then\n+        doMsg \"--> Nextcloud installato correttamente\"\n+    else\n+        doMsg \"--> Errore durante l'installazione di Nextcloud\"\n+        exit 1\n+    fi\n     \n     chmod +x ${NEXTCLOUD_FOLDER}/occ\n     $occ config:system:set overwriteprotocol --value \"${PROTOCOLWEB}\"\n     #pulisce dal cestino gli oggetti più vecchi di 30 giorni e quando serve spazio\n"
                },
                {
                    "date": 1698243405095,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -279,5 +279,5 @@\n configureNginx\n configureNginxCache\n getNC\n configureNextcloud\n-#customizingNextcloud\n+#customizingNextcloud\n\\ No newline at end of file\n"
                },
                {
                    "date": 1698243416196,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -24,8 +24,9 @@\n PROTOCOLWEB=http\n REDIS_HOSTNAME=localhost\n REDIS_PORT=6379\n #############################################\n+\n function doMsg(){\n     Green=$'\\e[1;32m'\n     White=$'\\e[0m'\n     msg=$1\n"
                },
                {
                    "date": 1698243452837,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -25,23 +25,17 @@\n REDIS_HOSTNAME=localhost\n REDIS_PORT=6379\n #############################################\n \n+#############################################\n+# Utility functions\n function doMsg(){\n     Green=$'\\e[1;32m'\n     White=$'\\e[0m'\n     msg=$1\n     echo \"${Green}\" \"${msg}\" \"${White}\"\n }\n \n-function installNginx(){\n-    doMsg \"--> Installo nginx e nginx-estras\"\n-    apt-get update -y\n-    doMsg \"--> Installazione nginx\"\n-    apt-get install nginx -y -qq\n-    apt-get install nginx-extras -y -qq\n-}\n-\n function startNginx(){\n     case $1 in\n         start)\n             doMsg \"--> Configurazione servizio systemd e avvio di Nginx\"\n@@ -62,8 +56,16 @@\n             ;;\n     esac\n }\n \n+function installNginx(){\n+    doMsg \"--> Installo nginx e nginx-estras\"\n+    apt-get update -y\n+    doMsg \"--> Installazione nginx\"\n+    apt-get install nginx -y -qq\n+    apt-get install nginx-extras -y -qq\n+}\n+\n function installPostgres(){\n     if [ -f /etc/apt/sources.list.d/pgdg.list ]; then\n         doMsg \"--> La repo di postgres è già presente, non la scarico\"\n     else\n"
                },
                {
                    "date": 1698243465465,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -55,8 +55,9 @@\n             exit 1\n             ;;\n     esac\n }\n+#############################################\n \n function installNginx(){\n     doMsg \"--> Installo nginx e nginx-estras\"\n     apt-get update -y\n"
                },
                {
                    "date": 1698243489536,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -25,10 +25,10 @@\n REDIS_HOSTNAME=localhost\n REDIS_PORT=6379\n #############################################\n \n+# Utility functions\n #############################################\n-# Utility functions\n function doMsg(){\n     Green=$'\\e[1;32m'\n     White=$'\\e[0m'\n     msg=$1\n"
                },
                {
                    "date": 1698243547563,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -271,9 +271,10 @@\n     $occ config:system:set enforce_language --value it\n     $occ config:system:set skeletondirectory --value \"\"\n }\n \n-\n+# Main\n+#############################################\n installNginx\n startNginx start\n installDep\n startNginx restart\n@@ -283,5 +284,6 @@\n configureNginx\n configureNginxCache\n getNC\n configureNextcloud\n-#customizingNextcloud\n\\ No newline at end of file\n+#customizingNextcloud\n+#############################################\n\\ No newline at end of file\n"
                },
                {
                    "date": 1698243567810,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -281,8 +281,9 @@\n installPostgres\n configureDatabase\n installRedis\n configureNginx\n+startNginx restart\n configureNginxCache\n getNC\n configureNextcloud\n #customizingNextcloud\n"
                },
                {
                    "date": 1698243901956,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,290 @@\n+#!/bin/bash\n+\n+#############################################\n+#                                           #\n+#  Script di installazione di nextcloud     #\n+#                                           #\n+#############################################\n+\n+# Variabili di configurazione\n+#############################################\n+PHPVERSION=8.1\n+POSTGRES_VERSION=15\n+NEXTCLOUD_VERSION=27.0.2\n+NEXTCLOUD_ADMIN=admin\n+NEXTCLOUD_ADMIN_PASSWORD=admin\n+NEXTCLOUD_POSTGRES_DB=nextcloud\n+NEXTCLOUD_POSTGRES_USER=nextcloud\n+NEXTCLOUD_POSTGRES_PASSWORD=nextcloud\n+WEB_FOLDER=/usr/share/nginx/html\n+NEXTCLOUD_FOLDER=${WEB_FOLDER}/nextcloud\n+occ=\"sudo -u www-data php ${NEXTCLOUD_FOLDER}/occ\"\n+DB_POSTGRES_HOST_IP=127.0.0.1\n+DB_POSTGRES_HOST_IP=5432\n+PROTOCOLWEB=http\n+REDIS_HOSTNAME=localhost\n+REDIS_PORT=6379\n+#############################################\n+\n+# Utility functions\n+#############################################\n+function doMsg(){\n+    Green=$'\\e[1;32m'\n+    White=$'\\e[0m'\n+    msg=$1\n+    echo \"${Green}\" \"${msg}\" \"${White}\"\n+}\n+\n+function startNginx(){\n+    case $1 in\n+        start)\n+            doMsg \"--> Configurazione servizio systemd e avvio di Nginx\"\n+            systemctl enable nginx\n+            systemctl start nginx\n+            ;;\n+        restart)\n+            doMsg \"--> Riavvio di Nginx\"\n+            systemctl restart nginx\n+            ;;\n+        stop)\n+            doMsg \"--> Arresto di Nginx\"\n+            systemctl stop nginx\n+            ;;\n+        *)\n+            doMsg \"--> Parametro non valido\"\n+            exit 1\n+            ;;\n+    esac\n+}\n+#############################################\n+\n+function installNginx(){\n+    doMsg \"--> Installo nginx e nginx-estras\"\n+    apt-get update -y\n+    doMsg \"--> Installazione nginx\"\n+    apt-get install nginx -y -qq\n+    apt-get install nginx-extras -y -qq\n+}\n+\n+function installPostgres(){\n+    if [ -f /etc/apt/sources.list.d/pgdg.list ]; then\n+        doMsg \"--> La repo di postgres è già presente, non la scarico\"\n+    else\n+        doMsg \"--> Aggiungo la repo di postgres\"\n+        sh -c 'echo \"deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list'\n+        wget -qO- https://www.postgresql.org/media/keys/ACCC4CF8.asc | tee /etc/apt/trusted.gpg.d/pgdg.asc &>/dev/null\n+        apt-get update\n+    fi\n+\n+    if [ $(apt list | grep installed | postgresql | wc -l) -gt 0 ]; then\n+        doMsg \"--> Postgresql è già installato\"\n+    else\n+        doMsg \"--> Installo postgresql\"\n+        apt-get install postgresql-${POSTGRES_VERSION} postgresql-client-${POSTGRES_VERSION} -y\n+    fi\n+\n+    doMsg \"--> Avvio postgresql ${POSTGRES_VERSION}\"\n+    systemctl start postgresql\n+}\n+\n+function configureDatabase(){\n+    doMsg \"--> Configuro il database\"\n+    sudo -u postgres psql <<END\n+    CREATE USER ${NEXTCLOUD_POSTGRES_USER} WITH PASSWORD '${NEXTCLOUD_POSTGRES_PASSWORD}';\n+    CREATE DATABASE ${NEXTCLOUD_POSTGRES_DB} TEMPLATE template0 ENCODING 'UNICODE';\n+    ALTER DATABASE ${NEXTCLOUD_POSTGRES_DB} OWNER TO ${NEXTCLOUD_POSTGRES_USER};\n+    GRANT ALL PRIVILEGES ON DATABASE ${NEXTCLOUD_POSTGRES_DB} TO ${NEXTCLOUD_POSTGRES_USER};\n+    GRANT CREATE ON SCHEMA public to ${NEXTCLOUD_POSTGRES_USER};\n+END\n+}\n+\n+function installRedis(){\n+    REDISCONFIGFILE=/etc/redis/redis.conf\n+    if [ -f ${REDISCONFIGFILE} ]; then\n+        doMsg \"--> Redis è già installato\"\n+    else\n+        doMsg \"--> Installo redis\"\n+        apt-get install redis-server -y -qq\n+        sed '/#ADDCUSTOM/,$d' ${REDISCONFIGFILE} > ${REDISCONFIGFILE}.new\n+        mv ${REDISCONFIGFILE} ${REDISCONFIGFILE}.old\n+        mv ${REDISCONFIGFILE}.new ${REDISCONFIGFILE}\n+        echo \"#ADDCUSTOM\" >> ${REDISCONFIGFILE}\n+        echo \"bind 127.0.0.1 ::1\" >> ${REDISCONFIGFILE}\n+    fi\n+    \n+    systemctl restart redis\n+}\n+\n+function installDep(){\n+    doMsg \"--> Installo le dipendenze\"\n+    apt-get install curl gnupg2 gnupg openssl ca-certificates lsb-release ubuntu-keyring unzip -y -qq\n+    apt-get install php${PHPVERSION} php${PHPVERSION}-fpm php${PHPVERSION}-gd php${PHPVERSION}-pgsql php${PHPVERSION}-curl \\\n+        php${PHPVERSION}-mbstring php${PHPVERSION}-intl php-apcu \\\n+        php${PHPVERSION}-gmp php${PHPVERSION}-bcmath php-imagick php${PHPVERSION}-xml php-redis php${PHPVERSION}-zip unzip libmagickcore-6.q16-3-extra \\\n+        php${PHPVERSION}-memcached php${PHPVERSION}-memcache -y -qq\n+}\n+\n+function downloadNC(){\n+    wget -O nextcloud-${NEXTCLOUD_VERSION}.zip https://download.nextcloud.com/server/releases/nextcloud-${NEXTCLOUD_VERSION}.zip\n+    md5sum nextcloud-${NEXTCLOUD_VERSION}.zip > nextcloud.md5\n+}\n+\n+function getNC(){\n+    doMsg \"--> Scarico la versione di nextcloud ${NEXTCLOUD_VERSION}\"\n+    cd $WEB_FOLDER\n+    if [ ! -f nextcloud.md5 ]; then\n+        downloadNC\n+    else\n+        md5sum -c nextcloud.md5\n+        if [ ! $? -eq 0 ]; then\n+            doMsg \"--> Pacchetto ${NEXTCLOUD_VERSION} già presente ma checksum cambiato, lo riscarico\"\n+            downloadNC\n+        else\n+            doMsg \"--> Il pacchetto ${NEXTCLOUD_VERSION} è già presente, non lo scarico\"\n+        fi\n+    fi\n+    cd $WEB_FOLDER/\n+    unzip -q -o nextcloud-${NEXTCLOUD_VERSION}.zip\n+}\n+\n+\n+function configureNginx(){\n+    doMsg \"--> Applico la configurazione di nginx\"\n+    sed -i 's/user  nginx;/user  www-data;/' /etc/nginx/nginx.conf\n+    cp /app/data/nextcloud.conf /etc/nginx/conf.d/\n+    if [ -f /etc/nginx/conf.d/default.conf ]; then\n+        mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.disabled\n+    fi\n+    if [ -f /etc/nginx/sites-enabled/default ]; then\n+        rm /etc/nginx/sites-enabled/default\n+    fi\n+}\n+\n+function configureNextcloud(){\n+    doMsg \"--> Controllo i permessi della cartella di setup\"\n+    chown -R www-data:www-data ${NEXTCLOUD_FOLDER}\n+\n+    doMsg \"--> Installo Nextcloud\"\n+    $occ maintenance:install --database \\\n+    \"pgsql\" --database-name \"${NEXTCLOUD_POSTGRES_DB}\"  --database-user \"${NEXTCLOUD_POSTGRES_USER}\" --database-pass \\\n+    \"${NEXTCLOUD_POSTGRES_PASSWORD}\" --database-host ${DB_POSTGRES_HOST_IP} --database-port ${DB_POSTGRES_PORT} --admin-user \\\n+    \"${NEXTCLOUD_ADMIN}\" --admin-pass \"${NEXTCLOUD_ADMIN_PASSWORD}\"\n+\n+    if [ $? -eq 0 ]; then\n+        doMsg \"--> Nextcloud installato correttamente\"\n+    else\n+        doMsg \"--> Errore durante l'installazione di Nextcloud\"\n+        exit 1\n+    fi\n+    \n+    chmod +x ${NEXTCLOUD_FOLDER}/occ\n+    $occ config:system:set overwriteprotocol --value \"${PROTOCOLWEB}\"\n+    #pulisce dal cestino gli oggetti più vecchi di 30 giorni e quando serve spazio\n+    $occ config:system:set trashbin_retention_obligation --value '30,auto'\n+    #Tiene le versioni dei file per 365 giorni, poi le imposta in stato expired e le tiene per altri 30 giorni\n+    $occ config:system:set versions_retention_obligation --value '365,30'\n+    $occ config:system:set htaccess.RewriteBase --value /\n+    $occ maintenance:update:htaccess #enabled pretty urls\n+    $occ config:system:set filelocking.enabled  --value=true\n+    $occ config:system:set redis host --value=\"${REDIS_HOSTNAME}\"\n+    $occ config:system:set redis port --value=\"${REDIS_PORT}\" --type=integer\n+    $occ config:system:set 'memcache.local' --value='\\OC\\Memcache\\APCu'\n+    $occ config:system:set 'memcache.distributed' --value='\\OC\\Memcache\\Redis'\n+    $occ config:system:set 'memcache.locking' --value='\\OC\\Memcache\\Redis'\n+\n+    #ogni altra configurazione utile è qui https://docs.nextcloud.com/server/19/admin_manual/configuration_server/config_sample_php_parameters.html?highlight=overwrite%20cli%20url\n+    chown -R www-data:www-data ${NEXTCLOUD_FOLDER}/config\n+    chmod -R 755 ${NEXTCLOUD_FOLDER}/config\n+    chmod 650 ${NEXTCLOUD_FOLDER}/config/*\n+}\n+\n+function configureNginxCache(){\n+    doMsg \"--> Configurazione delle ottimizzazioni per la cache\"\n+\n+    chmod -R 755 $NEXTCLOUD_FOLDER/config\n+\n+    export php_max_time=3600\n+    export php_memory_limit=512M\n+    export php_upload_limit=10G\n+\n+    cli_destination=\"/etc/php/${PHPVERSION}/cli/php.ini\"\n+    php_fpm_file=\"/etc/php/${PHPVERSION}/fpm/php.ini\"\n+    www_fpm_config=\"/etc/php/${PHPVERSION}/fpm/pool.d/www.conf\"\n+    if [ ! -f \"${cli_destination}.back\" ]; then\n+        cp -f \"${cli_destination}\" \"${cli_destination}.back\"\n+    else\n+        cp -f \"${cli_destination}.back\" \"${cli_destination}\"\n+    fi\n+    if [ ! -f \"${php_fpm_file}.back\" ]; then\n+        cp -f \"${php_fpm_file}\" \"${php_fpm_file}.back\"\n+    else\n+        cp -f \"${php_fpm_file}.back\" \"${php_fpm_file}\"\n+    fi\n+    if [ ! -f \"${www_fpm_config}.back\" ]; then\n+        cp -f \"${www_fpm_config}\" \"${www_fpm_config}.back\"\n+    else\n+        cp -f \"${www_fpm_config}.back\" \"${www_fpm_config}\" \n+    fi\n+    \n+    cd $NEXTCLOUD_FOLDER\n+\n+    sed -i -e \"s/memory_limit\\s*=.*/memory_limit = ${php_memory_limit}/g\" \\\n+        -e \"s/upload_max_filesize\\s*=.*/upload_max_filesize = ${php_upload_limit}/g\" \\\n+        -e \"s/post_max_size\\s*=.*/post_max_size = ${php_upload_limit}/g\" \\\n+        -e \"s/Max_execution_time\\s*=.*/max_execution_time = ${php_max_time}/g\" \\\n+        -e \"s/max_input_time\\s*=.*/max_input_time = ${php_max_time}/g\" \\\n+        -e \"s/;?opcache\\.save_comments=[^=]*/opcache.save_comments=1/\" \\\n+        -e \"s/;?opcache\\.revalidate_freq=[^=]*/opcache.revalidate_freq=60/\" \\\n+        -e \"s/;?opcache\\.memory_consumption=[^=]*/opcache.memory_consumption=64/\" \\\n+        -e \"s/;?opcache\\.interned_strings_buffer=[^=]*/opcache.interned_strings_buffer=32/\" \\\n+    \"${cli_destination}\"\n+\n+    sed -i -e \"s/memory_limit\\s*=.*/memory_limit = ${php_memory_limit}/g\" \\\n+        -e \"s/upload_max_filesize\\s*=.*/upload_max_filesize = ${php_upload_limit}/g\" \\\n+        -e \"s/post_max_size\\s*=.*/post_max_size = ${php_upload_limit}/g\" \\\n+        -e \"s/Max_execution_time\\s*=.*/max_execution_time = ${php_max_time}/g\" \\\n+        -e \"s/max_input_time\\s*=.*/max_input_time = ${php_max_time}/g\" \\\n+        -e \"s/;?opcache\\.save_comments=[^=]*/opcache.save_comments=1/\" \\\n+        -e \"s/;?opcache\\.revalidate_freq=[^=]*/opcache.revalidate_freq=60/\" \\\n+        -e \"s/;?opcache\\.memory_consumption=[^=]*/opcache.memory_consumption=64/\" \\\n+        -e \"s/;?opcache\\.interned_strings_buffer=[^=]*/opcache.interned_strings_buffer=32/\" \\\n+    \"${php_fpm_file}\"\n+\n+    sed -i -e '/clear_env/ s/^.//' ${www_fpm_config}\n+    sed -i -e '/env\\[/ s/^.//'  ${www_fpm_config}\n+\n+    echo apc.enable_cli=1 >> \"${cli_destination}\" \n+\n+    doMsg \"--> Applico le modifiche php\"\n+    systemctl restart php${PHPVERSION}-fpm\n+    systemctl restart nginx\n+}\n+\n+\n+function customizingNextcloud(){\n+    doMsg \"--> Configurazione di personalizzazioni utente\"\n+    $occ config:system:set default_phone_region --value=IT\n+    $occ config:system:set default_phone_region --value IT\n+    $occ config:system:set default_locale --value it_IT\n+    $occ config:system:set enforce_locale --value it_IT\n+    $occ config:system:set default_language --value it\n+    $occ config:system:set enforce_language --value it\n+    $occ config:system:set skeletondirectory --value \"\"\n+}\n+\n+# Main\n+#############################################\n+installNginx\n+startNginx start\n+installDep\n+startNginx restart\n+installPostgres\n+configureDatabase\n+installRedis\n+configureNginx\n+startNginx restart\n+getNC\n+configureNextcloud\n+configureNginxCache\n+#customizingNextcloud\n+#############################################\n\\ No newline at end of file\n"
                },
                {
                    "date": 1698243915307,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -150,9 +150,9 @@\n \n function configureNginx(){\n     doMsg \"--> Applico la configurazione di nginx\"\n     sed -i 's/user  nginx;/user  www-data;/' /etc/nginx/nginx.conf\n-    cp /app/data/nextcloud.conf /etc/nginx/conf.d/\n+    cp /app/scripts/nextcloud.conf /etc/nginx/conf.d/\n     if [ -f /etc/nginx/conf.d/default.conf ]; then\n         mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.disabled\n     fi\n     if [ -f /etc/nginx/sites-enabled/default ]; then\n@@ -286,295 +286,5 @@\n getNC\n configureNextcloud\n configureNginxCache\n #customizingNextcloud\n-#############################################\n-#!/bin/bash\n-\n-#############################################\n-#                                           #\n-#  Script di installazione di nextcloud     #\n-#                                           #\n-#############################################\n-\n-# Variabili di configurazione\n-#############################################\n-PHPVERSION=8.1\n-POSTGRES_VERSION=15\n-NEXTCLOUD_VERSION=27.0.2\n-NEXTCLOUD_ADMIN=admin\n-NEXTCLOUD_ADMIN_PASSWORD=admin\n-NEXTCLOUD_POSTGRES_DB=nextcloud\n-NEXTCLOUD_POSTGRES_USER=nextcloud\n-NEXTCLOUD_POSTGRES_PASSWORD=nextcloud\n-WEB_FOLDER=/usr/share/nginx/html\n-NEXTCLOUD_FOLDER=${WEB_FOLDER}/nextcloud\n-occ=\"sudo -u www-data php ${NEXTCLOUD_FOLDER}/occ\"\n-DB_POSTGRES_HOST_IP=127.0.0.1\n-DB_POSTGRES_HOST_IP=5432\n-PROTOCOLWEB=http\n-REDIS_HOSTNAME=localhost\n-REDIS_PORT=6379\n-#############################################\n-\n-# Utility functions\n-#############################################\n-function doMsg(){\n-    Green=$'\\e[1;32m'\n-    White=$'\\e[0m'\n-    msg=$1\n-    echo \"${Green}\" \"${msg}\" \"${White}\"\n-}\n-\n-function startNginx(){\n-    case $1 in\n-        start)\n-            doMsg \"--> Configurazione servizio systemd e avvio di Nginx\"\n-            systemctl enable nginx\n-            systemctl start nginx\n-            ;;\n-        restart)\n-            doMsg \"--> Riavvio di Nginx\"\n-            systemctl restart nginx\n-            ;;\n-        stop)\n-            doMsg \"--> Arresto di Nginx\"\n-            systemctl stop nginx\n-            ;;\n-        *)\n-            doMsg \"--> Parametro non valido\"\n-            exit 1\n-            ;;\n-    esac\n-}\n-#############################################\n-\n-function installNginx(){\n-    doMsg \"--> Installo nginx e nginx-estras\"\n-    apt-get update -y\n-    doMsg \"--> Installazione nginx\"\n-    apt-get install nginx -y -qq\n-    apt-get install nginx-extras -y -qq\n-}\n-\n-function installPostgres(){\n-    if [ -f /etc/apt/sources.list.d/pgdg.list ]; then\n-        doMsg \"--> La repo di postgres è già presente, non la scarico\"\n-    else\n-        doMsg \"--> Aggiungo la repo di postgres\"\n-        sh -c 'echo \"deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list'\n-        wget -qO- https://www.postgresql.org/media/keys/ACCC4CF8.asc | tee /etc/apt/trusted.gpg.d/pgdg.asc &>/dev/null\n-        apt-get update\n-    fi\n-\n-    if [ $(apt list | grep installed | postgresql | wc -l) -gt 0 ]; then\n-        doMsg \"--> Postgresql è già installato\"\n-    else\n-        doMsg \"--> Installo postgresql\"\n-        apt-get install postgresql-${POSTGRES_VERSION} postgresql-client-${POSTGRES_VERSION} -y\n-    fi\n-\n-    doMsg \"--> Avvio postgresql ${POSTGRES_VERSION}\"\n-    systemctl start postgresql\n-}\n-\n-function configureDatabase(){\n-    doMsg \"--> Configuro il database\"\n-    sudo -u postgres psql <<END\n-    CREATE USER ${NEXTCLOUD_POSTGRES_USER} WITH PASSWORD '${NEXTCLOUD_POSTGRES_PASSWORD}';\n-    CREATE DATABASE ${NEXTCLOUD_POSTGRES_DB} TEMPLATE template0 ENCODING 'UNICODE';\n-    ALTER DATABASE ${NEXTCLOUD_POSTGRES_DB} OWNER TO ${NEXTCLOUD_POSTGRES_USER};\n-    GRANT ALL PRIVILEGES ON DATABASE ${NEXTCLOUD_POSTGRES_DB} TO ${NEXTCLOUD_POSTGRES_USER};\n-    GRANT CREATE ON SCHEMA public to ${NEXTCLOUD_POSTGRES_USER};\n-END\n-}\n-\n-function installRedis(){\n-    REDISCONFIGFILE=/etc/redis/redis.conf\n-    if [ -f ${REDISCONFIGFILE} ]; then\n-        doMsg \"--> Redis è già installato\"\n-    else\n-        doMsg \"--> Installo redis\"\n-        apt-get install redis-server -y -qq\n-        sed '/#ADDCUSTOM/,$d' ${REDISCONFIGFILE} > ${REDISCONFIGFILE}.new\n-        mv ${REDISCONFIGFILE} ${REDISCONFIGFILE}.old\n-        mv ${REDISCONFIGFILE}.new ${REDISCONFIGFILE}\n-        echo \"#ADDCUSTOM\" >> ${REDISCONFIGFILE}\n-        echo \"bind 127.0.0.1 ::1\" >> ${REDISCONFIGFILE}\n-    fi\n-    \n-    systemctl restart redis\n-}\n-\n-function installDep(){\n-    doMsg \"--> Installo le dipendenze\"\n-    apt-get install curl gnupg2 gnupg openssl ca-certificates lsb-release ubuntu-keyring unzip -y -qq\n-    apt-get install php${PHPVERSION} php${PHPVERSION}-fpm php${PHPVERSION}-gd php${PHPVERSION}-pgsql php${PHPVERSION}-curl \\\n-        php${PHPVERSION}-mbstring php${PHPVERSION}-intl php-apcu \\\n-        php${PHPVERSION}-gmp php${PHPVERSION}-bcmath php-imagick php${PHPVERSION}-xml php-redis php${PHPVERSION}-zip unzip libmagickcore-6.q16-3-extra \\\n-        php${PHPVERSION}-memcached php${PHPVERSION}-memcache -y -qq\n-}\n-\n-function downloadNC(){\n-    wget -O nextcloud-${NEXTCLOUD_VERSION}.zip https://download.nextcloud.com/server/releases/nextcloud-${NEXTCLOUD_VERSION}.zip\n-    md5sum nextcloud-${NEXTCLOUD_VERSION}.zip > nextcloud.md5\n-}\n-\n-function getNC(){\n-    doMsg \"--> Scarico la versione di nextcloud ${NEXTCLOUD_VERSION}\"\n-    cd $WEB_FOLDER\n-    if [ ! -f nextcloud.md5 ]; then\n-        downloadNC\n-    else\n-        md5sum -c nextcloud.md5\n-        if [ ! $? -eq 0 ]; then\n-            doMsg \"--> Pacchetto ${NEXTCLOUD_VERSION} già presente ma checksum cambiato, lo riscarico\"\n-            downloadNC\n-        else\n-            doMsg \"--> Il pacchetto ${NEXTCLOUD_VERSION} è già presente, non lo scarico\"\n-        fi\n-    fi\n-    cd $WEB_FOLDER/\n-    unzip -q -o nextcloud-${NEXTCLOUD_VERSION}.zip\n-}\n-\n-\n-function configureNginx(){\n-    doMsg \"--> Applico la configurazione di nginx\"\n-    sed -i 's/user  nginx;/user  www-data;/' /etc/nginx/nginx.conf\n-    cp /app/data/nextcloud.conf /etc/nginx/conf.d/\n-    if [ -f /etc/nginx/conf.d/default.conf ]; then\n-        mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.disabled\n-    fi\n-    if [ -f /etc/nginx/sites-enabled/default ]; then\n-        rm /etc/nginx/sites-enabled/default\n-    fi\n-}\n-\n-function configureNextcloud(){\n-    doMsg \"--> Controllo i permessi della cartella di setup\"\n-    chown -R www-data:www-data ${NEXTCLOUD_FOLDER}\n-\n-    doMsg \"--> Installo Nextcloud\"\n-    $occ maintenance:install --database \\\n-    \"pgsql\" --database-name \"${NEXTCLOUD_POSTGRES_DB}\"  --database-user \"${NEXTCLOUD_POSTGRES_USER}\" --database-pass \\\n-    \"${NEXTCLOUD_POSTGRES_PASSWORD}\" --database-host ${DB_POSTGRES_HOST_IP} --database-port ${DB_POSTGRES_PORT} --admin-user \\\n-    \"${NEXTCLOUD_ADMIN}\" --admin-pass \"${NEXTCLOUD_ADMIN_PASSWORD}\"\n-\n-    if [ $? -eq 0 ]; then\n-        doMsg \"--> Nextcloud installato correttamente\"\n-    else\n-        doMsg \"--> Errore durante l'installazione di Nextcloud\"\n-        exit 1\n-    fi\n-    \n-    chmod +x ${NEXTCLOUD_FOLDER}/occ\n-    $occ config:system:set overwriteprotocol --value \"${PROTOCOLWEB}\"\n-    #pulisce dal cestino gli oggetti più vecchi di 30 giorni e quando serve spazio\n-    $occ config:system:set trashbin_retention_obligation --value '30,auto'\n-    #Tiene le versioni dei file per 365 giorni, poi le imposta in stato expired e le tiene per altri 30 giorni\n-    $occ config:system:set versions_retention_obligation --value '365,30'\n-    $occ config:system:set htaccess.RewriteBase --value /\n-    $occ maintenance:update:htaccess #enabled pretty urls\n-    $occ config:system:set filelocking.enabled  --value=true\n-    $occ config:system:set redis host --value=\"${REDIS_HOSTNAME}\"\n-    $occ config:system:set redis port --value=\"${REDIS_PORT}\" --type=integer\n-    $occ config:system:set 'memcache.local' --value='\\OC\\Memcache\\APCu'\n-    $occ config:system:set 'memcache.distributed' --value='\\OC\\Memcache\\Redis'\n-    $occ config:system:set 'memcache.locking' --value='\\OC\\Memcache\\Redis'\n-\n-    #ogni altra configurazione utile è qui https://docs.nextcloud.com/server/19/admin_manual/configuration_server/config_sample_php_parameters.html?highlight=overwrite%20cli%20url\n-    chown -R www-data:www-data ${NEXTCLOUD_FOLDER}/config\n-    chmod -R 755 ${NEXTCLOUD_FOLDER}/config\n-    chmod 650 ${NEXTCLOUD_FOLDER}/config/*\n-}\n-\n-function configureNginxCache(){\n-    doMsg \"--> Configurazione delle ottimizzazioni per la cache\"\n-\n-    chmod -R 755 $NEXTCLOUD_FOLDER/config\n-\n-    export php_max_time=3600\n-    export php_memory_limit=512M\n-    export php_upload_limit=10G\n-\n-    cli_destination=\"/etc/php/${PHPVERSION}/cli/php.ini\"\n-    php_fpm_file=\"/etc/php/${PHPVERSION}/fpm/php.ini\"\n-    www_fpm_config=\"/etc/php/${PHPVERSION}/fpm/pool.d/www.conf\"\n-    if [ ! -f \"${cli_destination}.back\" ]; then\n-        cp -f \"${cli_destination}\" \"${cli_destination}.back\"\n-    else\n-        cp -f \"${cli_destination}.back\" \"${cli_destination}\"\n-    fi\n-    if [ ! -f \"${php_fpm_file}.back\" ]; then\n-        cp -f \"${php_fpm_file}\" \"${php_fpm_file}.back\"\n-    else\n-        cp -f \"${php_fpm_file}.back\" \"${php_fpm_file}\"\n-    fi\n-    if [ ! -f \"${www_fpm_config}.back\" ]; then\n-        cp -f \"${www_fpm_config}\" \"${www_fpm_config}.back\"\n-    else\n-        cp -f \"${www_fpm_config}.back\" \"${www_fpm_config}\" \n-    fi\n-    \n-    cd $NEXTCLOUD_FOLDER\n-\n-    sed -i -e \"s/memory_limit\\s*=.*/memory_limit = ${php_memory_limit}/g\" \\\n-        -e \"s/upload_max_filesize\\s*=.*/upload_max_filesize = ${php_upload_limit}/g\" \\\n-        -e \"s/post_max_size\\s*=.*/post_max_size = ${php_upload_limit}/g\" \\\n-        -e \"s/Max_execution_time\\s*=.*/max_execution_time = ${php_max_time}/g\" \\\n-        -e \"s/max_input_time\\s*=.*/max_input_time = ${php_max_time}/g\" \\\n-        -e \"s/;?opcache\\.save_comments=[^=]*/opcache.save_comments=1/\" \\\n-        -e \"s/;?opcache\\.revalidate_freq=[^=]*/opcache.revalidate_freq=60/\" \\\n-        -e \"s/;?opcache\\.memory_consumption=[^=]*/opcache.memory_consumption=64/\" \\\n-        -e \"s/;?opcache\\.interned_strings_buffer=[^=]*/opcache.interned_strings_buffer=32/\" \\\n-    \"${cli_destination}\"\n-\n-    sed -i -e \"s/memory_limit\\s*=.*/memory_limit = ${php_memory_limit}/g\" \\\n-        -e \"s/upload_max_filesize\\s*=.*/upload_max_filesize = ${php_upload_limit}/g\" \\\n-        -e \"s/post_max_size\\s*=.*/post_max_size = ${php_upload_limit}/g\" \\\n-        -e \"s/Max_execution_time\\s*=.*/max_execution_time = ${php_max_time}/g\" \\\n-        -e \"s/max_input_time\\s*=.*/max_input_time = ${php_max_time}/g\" \\\n-        -e \"s/;?opcache\\.save_comments=[^=]*/opcache.save_comments=1/\" \\\n-        -e \"s/;?opcache\\.revalidate_freq=[^=]*/opcache.revalidate_freq=60/\" \\\n-        -e \"s/;?opcache\\.memory_consumption=[^=]*/opcache.memory_consumption=64/\" \\\n-        -e \"s/;?opcache\\.interned_strings_buffer=[^=]*/opcache.interned_strings_buffer=32/\" \\\n-    \"${php_fpm_file}\"\n-\n-    sed -i -e '/clear_env/ s/^.//' ${www_fpm_config}\n-    sed -i -e '/env\\[/ s/^.//'  ${www_fpm_config}\n-\n-    echo apc.enable_cli=1 >> \"${cli_destination}\" \n-\n-    doMsg \"--> Applico le modifiche php\"\n-    systemctl restart php${PHPVERSION}-fpm\n-    systemctl restart nginx\n-}\n-\n-\n-function customizingNextcloud(){\n-    doMsg \"--> Configurazione di personalizzazioni utente\"\n-    $occ config:system:set default_phone_region --value=IT\n-    $occ config:system:set default_phone_region --value IT\n-    $occ config:system:set default_locale --value it_IT\n-    $occ config:system:set enforce_locale --value it_IT\n-    $occ config:system:set default_language --value it\n-    $occ config:system:set enforce_language --value it\n-    $occ config:system:set skeletondirectory --value \"\"\n-}\n-\n-# Main\n-#############################################\n-installNginx\n-startNginx start\n-installDep\n-startNginx restart\n-installPostgres\n-configureDatabase\n-installRedis\n-configureNginx\n-startNginx restart\n-configureNginxCache\n-getNC\n-configureNextcloud\n-#customizingNextcloud\n #############################################\n\\ No newline at end of file\n"
                },
                {
                    "date": 1698244221721,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -281,9 +281,8 @@\n installPostgres\n configureDatabase\n installRedis\n configureNginx\n-startNginx restart\n getNC\n configureNextcloud\n configureNginxCache\n #customizingNextcloud\n"
                },
                {
                    "date": 1698244229822,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -276,14 +276,14 @@\n #############################################\n installNginx\n startNginx start\n installDep\n-startNginx restart\n installPostgres\n configureDatabase\n installRedis\n configureNginx\n getNC\n configureNextcloud\n configureNginxCache\n+startNginx restart\n #customizingNextcloud\n #############################################\n\\ No newline at end of file\n"
                },
                {
                    "date": 1698244984517,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -19,9 +19,9 @@\n WEB_FOLDER=/usr/share/nginx/html\n NEXTCLOUD_FOLDER=${WEB_FOLDER}/nextcloud\n occ=\"sudo -u www-data php ${NEXTCLOUD_FOLDER}/occ\"\n DB_POSTGRES_HOST_IP=127.0.0.1\n-DB_POSTGRES_HOST_IP=5432\n+DB_POSTGRES_PORT=5432\n PROTOCOLWEB=http\n REDIS_HOSTNAME=localhost\n REDIS_PORT=6379\n #############################################\n"
                },
                {
                    "date": 1698247457300,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -256,9 +256,9 @@\n     echo apc.enable_cli=1 >> \"${cli_destination}\" \n \n     doMsg \"--> Applico le modifiche php\"\n     systemctl restart php${PHPVERSION}-fpm\n-    systemctl restart nginx\n+    startNginx restart\n }\n \n \n function customizingNextcloud(){\n"
                },
                {
                    "date": 1698247476064,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -256,9 +256,8 @@\n     echo apc.enable_cli=1 >> \"${cli_destination}\" \n \n     doMsg \"--> Applico le modifiche php\"\n     systemctl restart php${PHPVERSION}-fpm\n-    startNginx restart\n }\n \n \n function customizingNextcloud(){\n"
                },
                {
                    "date": 1698247741905,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -258,9 +258,18 @@\n     doMsg \"--> Applico le modifiche php\"\n     systemctl restart php${PHPVERSION}-fpm\n }\n \n+function installCertbot(){\n+    doMsg \"--> Installo certbot\"\n+    apt-get install certbot python3-certbot-nginx -y -qq\n+}\n \n+function installCert(){\n+    doMsg \"--> Installo il certificato\"\n+    certbot certonly -d ${DOMAIN} -m ${EMAIL} --agree-tos --non-interactive\n+}\n+\n function customizingNextcloud(){\n     doMsg \"--> Configurazione di personalizzazioni utente\"\n     $occ config:system:set default_phone_region --value=IT\n     $occ config:system:set default_phone_region --value IT\n"
                },
                {
                    "date": 1698247760928,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,8 +23,10 @@\n DB_POSTGRES_PORT=5432\n PROTOCOLWEB=http\n REDIS_HOSTNAME=localhost\n REDIS_PORT=6379\n+DOMAIN=\n+EMAIL=\n #############################################\n \n # Utility functions\n #############################################\n"
                },
                {
                    "date": 1698247771274,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -293,7 +293,9 @@\n configureNginx\n getNC\n configureNextcloud\n configureNginxCache\n+installCertbot\n+installCert\n startNginx restart\n #customizingNextcloud\n #############################################\n\\ No newline at end of file\n"
                },
                {
                    "date": 1698247809566,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -267,9 +267,9 @@\n }\n \n function installCert(){\n     doMsg \"--> Installo il certificato\"\n-    certbot certonly -d ${DOMAIN} -m ${EMAIL} --agree-tos --non-interactive\n+    certbot certonly --standalone -d ${DOMAIN} -m ${EMAIL} --agree-tos --non-interactive\n }\n \n function customizingNextcloud(){\n     doMsg \"--> Configurazione di personalizzazioni utente\"\n"
                },
                {
                    "date": 1698247830850,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -189,9 +189,9 @@\n     $occ maintenance:update:htaccess #enabled pretty urls\n     $occ config:system:set filelocking.enabled  --value=true\n     $occ config:system:set redis host --value=\"${REDIS_HOSTNAME}\"\n     $occ config:system:set redis port --value=\"${REDIS_PORT}\" --type=integer\n-    $occ config:system:set 'memcache.local' --value='\\OC\\Memcache\\APCu'\n+    $occ config:system:set 'memcache.local' --value='\\OC\\Memcache\\Redis'\n     $occ config:system:set 'memcache.distributed' --value='\\OC\\Memcache\\Redis'\n     $occ config:system:set 'memcache.locking' --value='\\OC\\Memcache\\Redis'\n \n     #ogni altra configurazione utile è qui https://docs.nextcloud.com/server/19/admin_manual/configuration_server/config_sample_php_parameters.html?highlight=overwrite%20cli%20url\n"
                },
                {
                    "date": 1698247879090,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -192,8 +192,9 @@\n     $occ config:system:set redis port --value=\"${REDIS_PORT}\" --type=integer\n     $occ config:system:set 'memcache.local' --value='\\OC\\Memcache\\Redis'\n     $occ config:system:set 'memcache.distributed' --value='\\OC\\Memcache\\Redis'\n     $occ config:system:set 'memcache.locking' --value='\\OC\\Memcache\\Redis'\n+    \n \n     #ogni altra configurazione utile è qui https://docs.nextcloud.com/server/19/admin_manual/configuration_server/config_sample_php_parameters.html?highlight=overwrite%20cli%20url\n     chown -R www-data:www-data ${NEXTCLOUD_FOLDER}/config\n     chmod -R 755 ${NEXTCLOUD_FOLDER}/config\n"
                },
                {
                    "date": 1698247958779,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -192,9 +192,8 @@\n     $occ config:system:set redis port --value=\"${REDIS_PORT}\" --type=integer\n     $occ config:system:set 'memcache.local' --value='\\OC\\Memcache\\Redis'\n     $occ config:system:set 'memcache.distributed' --value='\\OC\\Memcache\\Redis'\n     $occ config:system:set 'memcache.locking' --value='\\OC\\Memcache\\Redis'\n-    \n \n     #ogni altra configurazione utile è qui https://docs.nextcloud.com/server/19/admin_manual/configuration_server/config_sample_php_parameters.html?highlight=overwrite%20cli%20url\n     chown -R www-data:www-data ${NEXTCLOUD_FOLDER}/config\n     chmod -R 755 ${NEXTCLOUD_FOLDER}/config\n@@ -271,8 +270,12 @@\n     doMsg \"--> Installo il certificato\"\n     certbot certonly --standalone -d ${DOMAIN} -m ${EMAIL} --agree-tos --non-interactive\n }\n \n+function selfSignedCerts(){\n+    openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /usr/share/nginx/ssl/key.pem -out /usr/share/nginx/ssl/cert.pem\n+}\n+\n function customizingNextcloud(){\n     doMsg \"--> Configurazione di personalizzazioni utente\"\n     $occ config:system:set default_phone_region --value=IT\n     $occ config:system:set default_phone_region --value IT\n"
                },
                {
                    "date": 1698248361051,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -180,8 +180,9 @@\n     fi\n     \n     chmod +x ${NEXTCLOUD_FOLDER}/occ\n     $occ config:system:set overwriteprotocol --value \"${PROTOCOLWEB}\"\n+    $occ config:system:set trusted_domains 1 --value \"${DOMAIN}\"\n     #pulisce dal cestino gli oggetti più vecchi di 30 giorni e quando serve spazio\n     $occ config:system:set trashbin_retention_obligation --value '30,auto'\n     #Tiene le versioni dei file per 365 giorni, poi le imposta in stato expired e le tiene per altri 30 giorni\n     $occ config:system:set versions_retention_obligation --value '365,30'\n"
                },
                {
                    "date": 1698265964149,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,306 +1,92 @@\n-#!/bin/bash\n+#!/usr/bin/env bash\n+sudo apt update && sudo apt upgrade && sudo apt install apache2 -y\n \n-#############################################\n-#                                           #\n-#  Script di installazione di nextcloud     #\n-#                                           #\n-#############################################\n+sudo chown -R www-data:www-data /var/www/html\n \n-# Variabili di configurazione\n-#############################################\n-PHPVERSION=8.1\n-POSTGRES_VERSION=15\n-NEXTCLOUD_VERSION=27.0.2\n-NEXTCLOUD_ADMIN=admin\n-NEXTCLOUD_ADMIN_PASSWORD=admin\n-NEXTCLOUD_POSTGRES_DB=nextcloud\n-NEXTCLOUD_POSTGRES_USER=nextcloud\n-NEXTCLOUD_POSTGRES_PASSWORD=nextcloud\n-WEB_FOLDER=/usr/share/nginx/html\n-NEXTCLOUD_FOLDER=${WEB_FOLDER}/nextcloud\n-occ=\"sudo -u www-data php ${NEXTCLOUD_FOLDER}/occ\"\n-DB_POSTGRES_HOST_IP=127.0.0.1\n-DB_POSTGRES_PORT=5432\n-PROTOCOLWEB=http\n-REDIS_HOSTNAME=localhost\n-REDIS_PORT=6379\n-DOMAIN=\n-EMAIL=\n-#############################################\n+WEBROOT=/var/www/html\n+cd /var/www/html\n+sudo mkdir portes\n+cd portes\n+touch index.html\n+cd ..\n \n-# Utility functions\n-#############################################\n-function doMsg(){\n-    Green=$'\\e[1;32m'\n-    White=$'\\e[0m'\n-    msg=$1\n-    echo \"${Green}\" \"${msg}\" \"${White}\"\n-}\n \n-function startNginx(){\n-    case $1 in\n-        start)\n-            doMsg \"--> Configurazione servizio systemd e avvio di Nginx\"\n-            systemctl enable nginx\n-            systemctl start nginx\n-            ;;\n-        restart)\n-            doMsg \"--> Riavvio di Nginx\"\n-            systemctl restart nginx\n-            ;;\n-        stop)\n-            doMsg \"--> Arresto di Nginx\"\n-            systemctl stop nginx\n-            ;;\n-        *)\n-            doMsg \"--> Parametro non valido\"\n-            exit 1\n-            ;;\n-    esac\n-}\n-#############################################\n+sudo echo \"<html>\" > /var/www/html/index.html\n+sudo echo \"<head>\" >> /var/www/html/index.html\n+sudo echo \"<title>Hello Word</title>\" >> /var/www/html/index.html\n+sudo echo \"</head>\" >> /var/www/html/index.html\n+sudo echo \"<body>\" >> /var/www/html/index.html\n+sudo echo \"<h1>Hello Word</h1>\" >> /var/www/html/index.html\n+sudo echo \"<p>Hello Word</p>\" >> /var/www/html/index.html\n+sudo echo \"</body>\" >> /var/www/html/index.html\n+sudo echo \"</html>\" >> /var/www/html/index.html\n \n-function installNginx(){\n-    doMsg \"--> Installo nginx e nginx-estras\"\n-    apt-get update -y\n-    doMsg \"--> Installazione nginx\"\n-    apt-get install nginx -y -qq\n-    apt-get install nginx-extras -y -qq\n-}\n \n-function installPostgres(){\n-    if [ -f /etc/apt/sources.list.d/pgdg.list ]; then\n-        doMsg \"--> La repo di postgres è già presente, non la scarico\"\n-    else\n-        doMsg \"--> Aggiungo la repo di postgres\"\n-        sh -c 'echo \"deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list'\n-        wget -qO- https://www.postgresql.org/media/keys/ACCC4CF8.asc | tee /etc/apt/trusted.gpg.d/pgdg.asc &>/dev/null\n-        apt-get update\n-    fi\n-\n-    if [ $(apt list | grep installed | postgresql | wc -l) -gt 0 ]; then\n-        doMsg \"--> Postgresql è già installato\"\n-    else\n-        doMsg \"--> Installo postgresql\"\n-        apt-get install postgresql-${POSTGRES_VERSION} postgresql-client-${POSTGRES_VERSION} -y\n-    fi\n-\n-    doMsg \"--> Avvio postgresql ${POSTGRES_VERSION}\"\n-    systemctl start postgresql\n-}\n-\n-function configureDatabase(){\n-    doMsg \"--> Configuro il database\"\n-    sudo -u postgres psql <<END\n-    CREATE USER ${NEXTCLOUD_POSTGRES_USER} WITH PASSWORD '${NEXTCLOUD_POSTGRES_PASSWORD}';\n-    CREATE DATABASE ${NEXTCLOUD_POSTGRES_DB} TEMPLATE template0 ENCODING 'UNICODE';\n-    ALTER DATABASE ${NEXTCLOUD_POSTGRES_DB} OWNER TO ${NEXTCLOUD_POSTGRES_USER};\n-    GRANT ALL PRIVILEGES ON DATABASE ${NEXTCLOUD_POSTGRES_DB} TO ${NEXTCLOUD_POSTGRES_USER};\n-    GRANT CREATE ON SCHEMA public to ${NEXTCLOUD_POSTGRES_USER};\n-END\n-}\n-\n-function installRedis(){\n-    REDISCONFIGFILE=/etc/redis/redis.conf\n-    if [ -f ${REDISCONFIGFILE} ]; then\n-        doMsg \"--> Redis è già installato\"\n-    else\n-        doMsg \"--> Installo redis\"\n-        apt-get install redis-server -y -qq\n-        sed '/#ADDCUSTOM/,$d' ${REDISCONFIGFILE} > ${REDISCONFIGFILE}.new\n-        mv ${REDISCONFIGFILE} ${REDISCONFIGFILE}.old\n-        mv ${REDISCONFIGFILE}.new ${REDISCONFIGFILE}\n-        echo \"#ADDCUSTOM\" >> ${REDISCONFIGFILE}\n-        echo \"bind 127.0.0.1 ::1\" >> ${REDISCONFIGFILE}\n-    fi\n-    \n-    systemctl restart redis\n-}\n-\n-function installDep(){\n-    doMsg \"--> Installo le dipendenze\"\n-    apt-get install curl gnupg2 gnupg openssl ca-certificates lsb-release ubuntu-keyring unzip -y -qq\n-    apt-get install php${PHPVERSION} php${PHPVERSION}-fpm php${PHPVERSION}-gd php${PHPVERSION}-pgsql php${PHPVERSION}-curl \\\n-        php${PHPVERSION}-mbstring php${PHPVERSION}-intl php-apcu \\\n-        php${PHPVERSION}-gmp php${PHPVERSION}-bcmath php-imagick php${PHPVERSION}-xml php-redis php${PHPVERSION}-zip unzip libmagickcore-6.q16-3-extra \\\n-        php${PHPVERSION}-memcached php${PHPVERSION}-memcache -y -qq\n-}\n-\n-function downloadNC(){\n-    wget -O nextcloud-${NEXTCLOUD_VERSION}.zip https://download.nextcloud.com/server/releases/nextcloud-${NEXTCLOUD_VERSION}.zip\n-    md5sum nextcloud-${NEXTCLOUD_VERSION}.zip > nextcloud.md5\n-}\n-\n-function getNC(){\n-    doMsg \"--> Scarico la versione di nextcloud ${NEXTCLOUD_VERSION}\"\n-    cd $WEB_FOLDER\n-    if [ ! -f nextcloud.md5 ]; then\n-        downloadNC\n-    else\n-        md5sum -c nextcloud.md5\n-        if [ ! $? -eq 0 ]; then\n-            doMsg \"--> Pacchetto ${NEXTCLOUD_VERSION} già presente ma checksum cambiato, lo riscarico\"\n-            downloadNC\n-        else\n-            doMsg \"--> Il pacchetto ${NEXTCLOUD_VERSION} è già presente, non lo scarico\"\n-        fi\n-    fi\n-    cd $WEB_FOLDER/\n-    unzip -q -o nextcloud-${NEXTCLOUD_VERSION}.zip\n-}\n-\n-\n-function configureNginx(){\n-    doMsg \"--> Applico la configurazione di nginx\"\n-    sed -i 's/user  nginx;/user  www-data;/' /etc/nginx/nginx.conf\n-    cp /app/scripts/nextcloud.conf /etc/nginx/conf.d/\n-    if [ -f /etc/nginx/conf.d/default.conf ]; then\n-        mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.disabled\n-    fi\n-    if [ -f /etc/nginx/sites-enabled/default ]; then\n-        rm /etc/nginx/sites-enabled/default\n-    fi\n-}\n-\n-function configureNextcloud(){\n-    doMsg \"--> Controllo i permessi della cartella di setup\"\n-    chown -R www-data:www-data ${NEXTCLOUD_FOLDER}\n-\n-    doMsg \"--> Installo Nextcloud\"\n-    $occ maintenance:install --database \\\n-    \"pgsql\" --database-name \"${NEXTCLOUD_POSTGRES_DB}\"  --database-user \"${NEXTCLOUD_POSTGRES_USER}\" --database-pass \\\n-    \"${NEXTCLOUD_POSTGRES_PASSWORD}\" --database-host ${DB_POSTGRES_HOST_IP} --database-port ${DB_POSTGRES_PORT} --admin-user \\\n-    \"${NEXTCLOUD_ADMIN}\" --admin-pass \"${NEXTCLOUD_ADMIN_PASSWORD}\"\n-\n-    if [ $? -eq 0 ]; then\n-        doMsg \"--> Nextcloud installato correttamente\"\n-    else\n-        doMsg \"--> Errore durante l'installazione di Nextcloud\"\n-        exit 1\n-    fi\n-    \n-    chmod +x ${NEXTCLOUD_FOLDER}/occ\n-    $occ config:system:set overwriteprotocol --value \"${PROTOCOLWEB}\"\n-    $occ config:system:set trusted_domains 1 --value \"${DOMAIN}\"\n-    #pulisce dal cestino gli oggetti più vecchi di 30 giorni e quando serve spazio\n-    $occ config:system:set trashbin_retention_obligation --value '30,auto'\n-    #Tiene le versioni dei file per 365 giorni, poi le imposta in stato expired e le tiene per altri 30 giorni\n-    $occ config:system:set versions_retention_obligation --value '365,30'\n-    $occ config:system:set htaccess.RewriteBase --value /\n-    $occ maintenance:update:htaccess #enabled pretty urls\n-    $occ config:system:set filelocking.enabled  --value=true\n-    $occ config:system:set redis host --value=\"${REDIS_HOSTNAME}\"\n-    $occ config:system:set redis port --value=\"${REDIS_PORT}\" --type=integer\n-    $occ config:system:set 'memcache.local' --value='\\OC\\Memcache\\Redis'\n-    $occ config:system:set 'memcache.distributed' --value='\\OC\\Memcache\\Redis'\n-    $occ config:system:set 'memcache.locking' --value='\\OC\\Memcache\\Redis'\n-\n-    #ogni altra configurazione utile è qui https://docs.nextcloud.com/server/19/admin_manual/configuration_server/config_sample_php_parameters.html?highlight=overwrite%20cli%20url\n-    chown -R www-data:www-data ${NEXTCLOUD_FOLDER}/config\n-    chmod -R 755 ${NEXTCLOUD_FOLDER}/config\n-    chmod 650 ${NEXTCLOUD_FOLDER}/config/*\n-}\n-\n-function configureNginxCache(){\n-    doMsg \"--> Configurazione delle ottimizzazioni per la cache\"\n-\n-    chmod -R 755 $NEXTCLOUD_FOLDER/config\n-\n-    export php_max_time=3600\n-    export php_memory_limit=512M\n-    export php_upload_limit=10G\n-\n-    cli_destination=\"/etc/php/${PHPVERSION}/cli/php.ini\"\n-    php_fpm_file=\"/etc/php/${PHPVERSION}/fpm/php.ini\"\n-    www_fpm_config=\"/etc/php/${PHPVERSION}/fpm/pool.d/www.conf\"\n-    if [ ! -f \"${cli_destination}.back\" ]; then\n-        cp -f \"${cli_destination}\" \"${cli_destination}.back\"\n-    else\n-        cp -f \"${cli_destination}.back\" \"${cli_destination}\"\n-    fi\n-    if [ ! -f \"${php_fpm_file}.back\" ]; then\n-        cp -f \"${php_fpm_file}\" \"${php_fpm_file}.back\"\n-    else\n-        cp -f \"${php_fpm_file}.back\" \"${php_fpm_file}\"\n-    fi\n-    if [ ! -f \"${www_fpm_config}.back\" ]; then\n-        cp -f \"${www_fpm_config}\" \"${www_fpm_config}.back\"\n-    else\n-        cp -f \"${www_fpm_config}.back\" \"${www_fpm_config}\" \n-    fi\n-    \n-    cd $NEXTCLOUD_FOLDER\n-\n-    sed -i -e \"s/memory_limit\\s*=.*/memory_limit = ${php_memory_limit}/g\" \\\n-        -e \"s/upload_max_filesize\\s*=.*/upload_max_filesize = ${php_upload_limit}/g\" \\\n-        -e \"s/post_max_size\\s*=.*/post_max_size = ${php_upload_limit}/g\" \\\n-        -e \"s/Max_execution_time\\s*=.*/max_execution_time = ${php_max_time}/g\" \\\n-        -e \"s/max_input_time\\s*=.*/max_input_time = ${php_max_time}/g\" \\\n-        -e \"s/;?opcache\\.save_comments=[^=]*/opcache.save_comments=1/\" \\\n-        -e \"s/;?opcache\\.revalidate_freq=[^=]*/opcache.revalidate_freq=60/\" \\\n-        -e \"s/;?opcache\\.memory_consumption=[^=]*/opcache.memory_consumption=64/\" \\\n-        -e \"s/;?opcache\\.interned_strings_buffer=[^=]*/opcache.interned_strings_buffer=32/\" \\\n-    \"${cli_destination}\"\n-\n-    sed -i -e \"s/memory_limit\\s*=.*/memory_limit = ${php_memory_limit}/g\" \\\n-        -e \"s/upload_max_filesize\\s*=.*/upload_max_filesize = ${php_upload_limit}/g\" \\\n-        -e \"s/post_max_size\\s*=.*/post_max_size = ${php_upload_limit}/g\" \\\n-        -e \"s/Max_execution_time\\s*=.*/max_execution_time = ${php_max_time}/g\" \\\n-        -e \"s/max_input_time\\s*=.*/max_input_time = ${php_max_time}/g\" \\\n-        -e \"s/;?opcache\\.save_comments=[^=]*/opcache.save_comments=1/\" \\\n-        -e \"s/;?opcache\\.revalidate_freq=[^=]*/opcache.revalidate_freq=60/\" \\\n-        -e \"s/;?opcache\\.memory_consumption=[^=]*/opcache.memory_consumption=64/\" \\\n-        -e \"s/;?opcache\\.interned_strings_buffer=[^=]*/opcache.interned_strings_buffer=32/\" \\\n-    \"${php_fpm_file}\"\n-\n-    sed -i -e '/clear_env/ s/^.//' ${www_fpm_config}\n-    sed -i -e '/env\\[/ s/^.//'  ${www_fpm_config}\n-\n-    echo apc.enable_cli=1 >> \"${cli_destination}\" \n-\n-    doMsg \"--> Applico le modifiche php\"\n-    systemctl restart php${PHPVERSION}-fpm\n-}\n-\n-function installCertbot(){\n-    doMsg \"--> Installo certbot\"\n-    apt-get install certbot python3-certbot-nginx -y -qq\n-}\n-\n-function installCert(){\n-    doMsg \"--> Installo il certificato\"\n-    certbot certonly --standalone -d ${DOMAIN} -m ${EMAIL} --agree-tos --non-interactive\n-}\n-\n-function selfSignedCerts(){\n-    openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /usr/share/nginx/ssl/key.pem -out /usr/share/nginx/ssl/cert.pem\n-}\n-\n-function customizingNextcloud(){\n-    doMsg \"--> Configurazione di personalizzazioni utente\"\n-    $occ config:system:set default_phone_region --value=IT\n-    $occ config:system:set default_phone_region --value IT\n-    $occ config:system:set default_locale --value it_IT\n-    $occ config:system:set enforce_locale --value it_IT\n-    $occ config:system:set default_language --value it\n-    $occ config:system:set enforce_language --value it\n-    $occ config:system:set skeletondirectory --value \"\"\n-}\n\\ No newline at end of file\n-\n-# Main\n-#############################################\n-installNginx\n-startNginx start\n-installDep\n-installPostgres\n-configureDatabase\n-installRedis\n-configureNginx\n-getNC\n-configureNextcloud\n-configureNginxCache\n-installCertbot\n-installCert\n-startNginx restart\n-#customizingNextcloud\n-#############################################\n+sudo echo \"<html>\" > /var/www/html/portes/index.html\n+sudo echo \"<head>\" >> /var/www/html/portes/index.html\n+sudo echo \"<meta charset=\"UTF-8\">\" >> /var/www/html/portes/index.html\n+sudo echo \"<title>Il Mio Portfolio</title>\" >> /var/www/html/portes/index.html\n+sudo echo \"<style>\" >> /var/www/html/portes/index.html\n+sudo echo \"body {\" >> /var/www/html/portes/index.html\n+sudo echo \"font-family: Arial, sans-serif;\" >> /var/www/html/portes/index.html\n+sudo echo \"background-color: #f4f4f4;\" >> /var/www/html/portes/index.html\n+sudo echo \"margin: 0;\" >> /var/www/html/portes/index.html\n+sudo echo \"padding: 0;\" >> /var/www/html/portes/index.html\n+sudo echo \"}\" >> /var/www/html/portes/index.html\n+sudo echo \"header {\" >> /var/www/html/portes/index.html\n+sudo echo \"background-color: #333;\" >> /var/www/html/portes/index.html\n+sudo echo \"color: #fff;\" >> /var/www/html/portes/index.html\n+sudo echo \"text-align: center;\" >> /var/www/html/portes/index.html\n+sudo echo \"padding: 20px 0;\" >> /var/www/html/portes/index.html\n+sudo echo \"}\" >> /var/www/html/portes/index.html\n+sudo echo \"h1 {\" >> /var/www/html/portes/index.html\n+sudo echo \"font-size: 2em;\" >> /var/www/html/portes/index.html\n+sudo echo \"}\" >> /var/www/html/portes/index.html\n+sudo echo \"section {\" >> /var/www/html/portes/index.html\n+sudo echo \"max-width: 800px;\" >> /var/www/html/portes/index.html\n+sudo echo \"margin: 20px auto;\" >> /var/www/html/portes/index.html\n+sudo echo \"padding: 20px;\" >> /var/www/html/portes/index.html\n+sudo echo \"background-color: #fff;\" >> /var/www/html/portes/index.html\n+sudo echo \"}\" >> /var/www/html/portes/index.html\n+sudo echo \"h2 {\" >> /var/www/html/portes/index.html\n+sudo echo \"font-size: 1.5em;\" >> /var/www/html/portes/index.html\n+sudo echo \"}\" >> /var/www/html/portes/index.html\n+sudo echo \"p {\" >> /var/www/html/portes/index.html\n+sudo echo \"font-size: 1.2em;\" >> /var/www/html/portes/index.html\n+sudo echo \"}\" >> /var/www/html/portes/index.html\n+sudo echo \".project {\" >> /var/www/html/portes/index.html\n+sudo echo \"margin-bottom: 20px;\" >> /var/www/html/portes/index.html\n+sudo echo \"}\" >> /var/www/html/portes/index.html\n+sudo echo \"footer {\" >> /var/www/html/portes/index.html\n+sudo echo \"background-color: #333;\" >> /var/www/html/portes/index.html\n+sudo echo \"color: #fff;\" >> /var/www/html/portes/index.html\n+sudo echo \"text-align: center;\" >> /var/www/html/portes/index.html\n+sudo echo \"padding: 10px 0;\" >> /var/www/html/portes/index.html\n+sudo echo \"}\" >> /var/www/html/portes/index.html\n+sudo echo \"</style>\" >> /var/www/html/portes/index.html\n+sudo echo \"</head>\" >> /var/www/html/portes/index.html\n+sudo echo \"<body>\" >> /var/www/html/portes/index.html\n+sudo echo \"<header>\" >> /var/www/html/portes/index.html\n+sudo echo \"<h1>Il Mio Portfolio</h1>\" >> /var/www/html/portes/index.html\n+sudo echo \"<p>Benvenuto nel mio portfolio personale</p>\" >> /var/www/html/portes/index.html\n+sudo echo \"</header>\" >> /var/www/html/portes/index.html\n+sudo echo \"<section>\" >> /var/www/html/portes/index.html\n+sudo echo \"<h2>Chi Sono</h2>\" >> /var/www/html/portes/index.html\n+sudo echo \"<p>Ciao, sono [Il Tuo Nome]. Sono uno sviluppatore web appassionato di progettazione e sviluppo di siti web creativi e coinvolgenti.</p>\" >> /var/www/html/portes/index.html\n+sudo echo \"</section>\" >> /var/www/html/portes/index.html\n+sudo echo \"<section>\" >> /var/www/html/portes/index.html\n+sudo echo \"<h2>I Miei Progetti</h2>\" >> /var/www/html/portes/index.html\n+sudo echo \"<div class=\"project\">\" >> /var/www/html/portes/index.html\n+sudo echo \"<h3>Progetto 1</h3>\" >> /var/www/html/portes/index.html\n+sudo echo \"<p>Descrizione del primo progetto. Qui puoi scrivere di più sui dettagli e le tecnologie utilizzate.</p>\" >> /var/www/html/portes/index.html\n+sudo echo \"</div>\" >> /var/www/html/portes/index.html\n+sudo echo \"<div class=\"project\">\" >> /var/www/html/portes/index.html\n+sudo echo \"<h3>Progetto 2</h3>\" >> /var/www/html/portes/index.html\n+sudo echo \"<p>Descrizione del secondo progetto. Puoi anche includere collegamenti ai progetti se desideri.</p>\" >> /var/www/html/portes/index.html\n+sudo echo \"</div>\" >> /var/www/html/portes/index.html\n+sudo echo \"</section>\" >> /var/www/html/portes/index.html\n+sudo echo \"<footer>\" >> /var/www/html/portes/index.html\n+sudo echo \"<p>&copy; 2023 Il Mio Portfolio</p>\" >> /var/www/html/portes/index.html\n+sudo echo \"</footer>\" >> /var/www/html/portes/index.html\n+sudo echo \"</body>\" >> /var/www/html/portes/index.html\n+sudo echo \"</html>\" >> /var/www/html/portes/index.html\n\\ No newline at end of file\n"
                },
                {
                    "date": 1698265969602,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,9 +3,9 @@\n \n sudo chown -R www-data:www-data /var/www/html\n \n WEBROOT=/var/www/html\n-cd /var/www/html\n+cd $WEBROOT\n sudo mkdir portes\n cd portes\n touch index.html\n cd ..\n"
                },
                {
                    "date": 1698265977864,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,8 +4,9 @@\n sudo chown -R www-data:www-data /var/www/html\n \n WEBROOT=/var/www/html\n cd $WEBROOT\n+SITEROOT=$WEBROOT/portes\n sudo mkdir portes\n cd portes\n touch index.html\n cd ..\n"
                },
                {
                    "date": 1698265988063,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,9 +5,9 @@\n \n WEBROOT=/var/www/html\n cd $WEBROOT\n SITEROOT=$WEBROOT/portes\n-sudo mkdir portes\n+sudo mkdir -p $SITEROOT\n cd portes\n touch index.html\n cd ..\n \n"
                },
                {
                    "date": 1698266061768,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,91 +3,91 @@\n \n sudo chown -R www-data:www-data /var/www/html\n \n WEBROOT=/var/www/html\n-cd $WEBROOT\n-SITEROOT=$WEBROOT/portes\n+cd $WEBROOT/\n+SITEROOT=$WEBROOT//portes\n sudo mkdir -p $SITEROOT\n-cd portes\n+cd $SITEROOT\n touch index.html\n cd ..\n \n \n-sudo echo \"<html>\" > /var/www/html/index.html\n-sudo echo \"<head>\" >> /var/www/html/index.html\n-sudo echo \"<title>Hello Word</title>\" >> /var/www/html/index.html\n-sudo echo \"</head>\" >> /var/www/html/index.html\n-sudo echo \"<body>\" >> /var/www/html/index.html\n-sudo echo \"<h1>Hello Word</h1>\" >> /var/www/html/index.html\n-sudo echo \"<p>Hello Word</p>\" >> /var/www/html/index.html\n-sudo echo \"</body>\" >> /var/www/html/index.html\n-sudo echo \"</html>\" >> /var/www/html/index.html\n+sudo echo \"<html>\" > $WEBROOT/index.html\n+sudo echo \"<head>\" >> $WEBROOT/index.html\n+sudo echo \"<title>Hello Word</title>\" >> $WEBROOT/index.html\n+sudo echo \"</head>\" >> $WEBROOT/index.html\n+sudo echo \"<body>\" >> $WEBROOT/index.html\n+sudo echo \"<h1>Hello Word</h1>\" >> $WEBROOT/index.html\n+sudo echo \"<p>Hello Word</p>\" >> $WEBROOT/index.html\n+sudo echo \"</body>\" >> $WEBROOT/index.html\n+sudo echo \"</html>\" >> $WEBROOT/index.html\n \n \n-sudo echo \"<html>\" > /var/www/html/portes/index.html\n-sudo echo \"<head>\" >> /var/www/html/portes/index.html\n-sudo echo \"<meta charset=\"UTF-8\">\" >> /var/www/html/portes/index.html\n-sudo echo \"<title>Il Mio Portfolio</title>\" >> /var/www/html/portes/index.html\n-sudo echo \"<style>\" >> /var/www/html/portes/index.html\n-sudo echo \"body {\" >> /var/www/html/portes/index.html\n-sudo echo \"font-family: Arial, sans-serif;\" >> /var/www/html/portes/index.html\n-sudo echo \"background-color: #f4f4f4;\" >> /var/www/html/portes/index.html\n-sudo echo \"margin: 0;\" >> /var/www/html/portes/index.html\n-sudo echo \"padding: 0;\" >> /var/www/html/portes/index.html\n-sudo echo \"}\" >> /var/www/html/portes/index.html\n-sudo echo \"header {\" >> /var/www/html/portes/index.html\n-sudo echo \"background-color: #333;\" >> /var/www/html/portes/index.html\n-sudo echo \"color: #fff;\" >> /var/www/html/portes/index.html\n-sudo echo \"text-align: center;\" >> /var/www/html/portes/index.html\n-sudo echo \"padding: 20px 0;\" >> /var/www/html/portes/index.html\n-sudo echo \"}\" >> /var/www/html/portes/index.html\n-sudo echo \"h1 {\" >> /var/www/html/portes/index.html\n-sudo echo \"font-size: 2em;\" >> /var/www/html/portes/index.html\n-sudo echo \"}\" >> /var/www/html/portes/index.html\n-sudo echo \"section {\" >> /var/www/html/portes/index.html\n-sudo echo \"max-width: 800px;\" >> /var/www/html/portes/index.html\n-sudo echo \"margin: 20px auto;\" >> /var/www/html/portes/index.html\n-sudo echo \"padding: 20px;\" >> /var/www/html/portes/index.html\n-sudo echo \"background-color: #fff;\" >> /var/www/html/portes/index.html\n-sudo echo \"}\" >> /var/www/html/portes/index.html\n-sudo echo \"h2 {\" >> /var/www/html/portes/index.html\n-sudo echo \"font-size: 1.5em;\" >> /var/www/html/portes/index.html\n-sudo echo \"}\" >> /var/www/html/portes/index.html\n-sudo echo \"p {\" >> /var/www/html/portes/index.html\n-sudo echo \"font-size: 1.2em;\" >> /var/www/html/portes/index.html\n-sudo echo \"}\" >> /var/www/html/portes/index.html\n-sudo echo \".project {\" >> /var/www/html/portes/index.html\n-sudo echo \"margin-bottom: 20px;\" >> /var/www/html/portes/index.html\n-sudo echo \"}\" >> /var/www/html/portes/index.html\n-sudo echo \"footer {\" >> /var/www/html/portes/index.html\n-sudo echo \"background-color: #333;\" >> /var/www/html/portes/index.html\n-sudo echo \"color: #fff;\" >> /var/www/html/portes/index.html\n-sudo echo \"text-align: center;\" >> /var/www/html/portes/index.html\n-sudo echo \"padding: 10px 0;\" >> /var/www/html/portes/index.html\n-sudo echo \"}\" >> /var/www/html/portes/index.html\n-sudo echo \"</style>\" >> /var/www/html/portes/index.html\n-sudo echo \"</head>\" >> /var/www/html/portes/index.html\n-sudo echo \"<body>\" >> /var/www/html/portes/index.html\n-sudo echo \"<header>\" >> /var/www/html/portes/index.html\n-sudo echo \"<h1>Il Mio Portfolio</h1>\" >> /var/www/html/portes/index.html\n-sudo echo \"<p>Benvenuto nel mio portfolio personale</p>\" >> /var/www/html/portes/index.html\n-sudo echo \"</header>\" >> /var/www/html/portes/index.html\n-sudo echo \"<section>\" >> /var/www/html/portes/index.html\n-sudo echo \"<h2>Chi Sono</h2>\" >> /var/www/html/portes/index.html\n-sudo echo \"<p>Ciao, sono [Il Tuo Nome]. Sono uno sviluppatore web appassionato di progettazione e sviluppo di siti web creativi e coinvolgenti.</p>\" >> /var/www/html/portes/index.html\n-sudo echo \"</section>\" >> /var/www/html/portes/index.html\n-sudo echo \"<section>\" >> /var/www/html/portes/index.html\n-sudo echo \"<h2>I Miei Progetti</h2>\" >> /var/www/html/portes/index.html\n-sudo echo \"<div class=\"project\">\" >> /var/www/html/portes/index.html\n-sudo echo \"<h3>Progetto 1</h3>\" >> /var/www/html/portes/index.html\n\\ No newline at end of file\n-sudo echo \"<p>Descrizione del primo progetto. Qui puoi scrivere di più sui dettagli e le tecnologie utilizzate.</p>\" >> /var/www/html/portes/index.html\n-sudo echo \"</div>\" >> /var/www/html/portes/index.html\n-sudo echo \"<div class=\"project\">\" >> /var/www/html/portes/index.html\n-sudo echo \"<h3>Progetto 2</h3>\" >> /var/www/html/portes/index.html\n-sudo echo \"<p>Descrizione del secondo progetto. Puoi anche includere collegamenti ai progetti se desideri.</p>\" >> /var/www/html/portes/index.html\n-sudo echo \"</div>\" >> /var/www/html/portes/index.html\n-sudo echo \"</section>\" >> /var/www/html/portes/index.html\n-sudo echo \"<footer>\" >> /var/www/html/portes/index.html\n-sudo echo \"<p>&copy; 2023 Il Mio Portfolio</p>\" >> /var/www/html/portes/index.html\n-sudo echo \"</footer>\" >> /var/www/html/portes/index.html\n-sudo echo \"</body>\" >> /var/www/html/portes/index.html\n-sudo echo \"</html>\" >> /var/www/html/portes/index.html\n+sudo echo \"<html>\" > $SITEROOT/index.html\n+sudo echo \"<head>\" >> $SITEROOT/index.html\n+sudo echo \"<meta charset=\"UTF-8\">\" >> $SITEROOT/index.html\n+sudo echo \"<title>Il Mio Portfolio</title>\" >> $SITEROOT/index.html\n+sudo echo \"<style>\" >> $SITEROOT/index.html\n+sudo echo \"body {\" >> $SITEROOT/index.html\n+sudo echo \"font-family: Arial, sans-serif;\" >> $SITEROOT/index.html\n+sudo echo \"background-color: #f4f4f4;\" >> $SITEROOT/index.html\n+sudo echo \"margin: 0;\" >> $SITEROOT/index.html\n+sudo echo \"padding: 0;\" >> $SITEROOT/index.html\n+sudo echo \"}\" >> $SITEROOT/index.html\n+sudo echo \"header {\" >> $SITEROOT/index.html\n+sudo echo \"background-color: #333;\" >> $SITEROOT/index.html\n+sudo echo \"color: #fff;\" >> $SITEROOT/index.html\n+sudo echo \"text-align: center;\" >> $SITEROOT/index.html\n+sudo echo \"padding: 20px 0;\" >> $SITEROOT/index.html\n+sudo echo \"}\" >> $SITEROOT/index.html\n+sudo echo \"h1 {\" >> $SITEROOT/index.html\n+sudo echo \"font-size: 2em;\" >> $SITEROOT/index.html\n+sudo echo \"}\" >> $SITEROOT/index.html\n+sudo echo \"section {\" >> $SITEROOT/index.html\n+sudo echo \"max-width: 800px;\" >> $SITEROOT/index.html\n+sudo echo \"margin: 20px auto;\" >> $SITEROOT/index.html\n+sudo echo \"padding: 20px;\" >> $SITEROOT/index.html\n+sudo echo \"background-color: #fff;\" >> $SITEROOT/index.html\n+sudo echo \"}\" >> $SITEROOT/index.html\n+sudo echo \"h2 {\" >> $SITEROOT/index.html\n+sudo echo \"font-size: 1.5em;\" >> $SITEROOT/index.html\n+sudo echo \"}\" >> $SITEROOT/index.html\n+sudo echo \"p {\" >> $SITEROOT/index.html\n+sudo echo \"font-size: 1.2em;\" >> $SITEROOT/index.html\n+sudo echo \"}\" >> $SITEROOT/index.html\n+sudo echo \".project {\" >> $SITEROOT/index.html\n+sudo echo \"margin-bottom: 20px;\" >> $SITEROOT/index.html\n+sudo echo \"}\" >> $SITEROOT/index.html\n+sudo echo \"footer {\" >> $SITEROOT/index.html\n+sudo echo \"background-color: #333;\" >> $SITEROOT/index.html\n+sudo echo \"color: #fff;\" >> $SITEROOT/index.html\n+sudo echo \"text-align: center;\" >> $SITEROOT/index.html\n+sudo echo \"padding: 10px 0;\" >> $SITEROOT/index.html\n+sudo echo \"}\" >> $SITEROOT/index.html\n+sudo echo \"</style>\" >> $SITEROOT/index.html\n+sudo echo \"</head>\" >> $SITEROOT/index.html\n+sudo echo \"<body>\" >> $SITEROOT/index.html\n+sudo echo \"<header>\" >> $SITEROOT/index.html\n+sudo echo \"<h1>Il Mio Portfolio</h1>\" >> $SITEROOT/index.html\n+sudo echo \"<p>Benvenuto nel mio portfolio personale</p>\" >> $SITEROOT/index.html\n+sudo echo \"</header>\" >> $SITEROOT/index.html\n+sudo echo \"<section>\" >> $SITEROOT/index.html\n+sudo echo \"<h2>Chi Sono</h2>\" >> $SITEROOT/index.html\n+sudo echo \"<p>Ciao, sono [Il Tuo Nome]. Sono uno sviluppatore web appassionato di progettazione e sviluppo di siti web creativi e coinvolgenti.</p>\" >> $SITEROOT/index.html\n+sudo echo \"</section>\" >> $SITEROOT/index.html\n+sudo echo \"<section>\" >> $SITEROOT/index.html\n+sudo echo \"<h2>I Miei Progetti</h2>\" >> $SITEROOT/index.html\n+sudo echo \"<div class=\"project\">\" >> $SITEROOT/index.html\n+sudo echo \"<h3>Progetto 1</h3>\" >> $SITEROOT/index.html\n+sudo echo \"<p>Descrizione del primo progetto. Qui puoi scrivere di più sui dettagli e le tecnologie utilizzate.</p>\" >> $SITEROOT/index.html\n+sudo echo \"</div>\" >> $SITEROOT/index.html\n+sudo echo \"<div class=\"project\">\" >> $SITEROOT/index.html\n+sudo echo \"<h3>Progetto 2</h3>\" >> $SITEROOT/index.html\n+sudo echo \"<p>Descrizione del secondo progetto. Puoi anche includere collegamenti ai progetti se desideri.</p>\" >> $SITEROOT/index.html\n+sudo echo \"</div>\" >> $SITEROOT/index.html\n+sudo echo \"</section>\" >> $SITEROOT/index.html\n+sudo echo \"<footer>\" >> $SITEROOT/index.html\n+sudo echo \"<p>&copy; 2023 Il Mio Portfolio</p>\" >> $SITEROOT/index.html\n+sudo echo \"</footer>\" >> $SITEROOT/index.html\n+sudo echo \"</body>\" >> $SITEROOT/index.html\n+sudo echo \"</html>\" >> $SITEROOT/index.html\n\\ No newline at end of file\n"
                },
                {
                    "date": 1698266081223,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,12 +1,15 @@\n #!/usr/bin/env bash\n+\n+WEBROOT=/var/www/html\n+SITEROOT=$WEBROOT/portes\n sudo apt update && sudo apt upgrade && sudo apt install apache2 -y\n \n sudo chown -R www-data:www-data /var/www/html\n \n-WEBROOT=/var/www/html\n+\n cd $WEBROOT/\n-SITEROOT=$WEBROOT//portes\n+\n sudo mkdir -p $SITEROOT\n cd $SITEROOT\n touch index.html\n cd ..\n"
                },
                {
                    "date": 1698266086544,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,9 @@\n #!/usr/bin/env bash\n \n WEBROOT=/var/www/html\n SITEROOT=$WEBROOT/portes\n+\n sudo apt update && sudo apt upgrade && sudo apt install apache2 -y\n \n sudo chown -R www-data:www-data /var/www/html\n \n"
                },
                {
                    "date": 1698266091957,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,9 +4,9 @@\n SITEROOT=$WEBROOT/portes\n \n sudo apt update && sudo apt upgrade && sudo apt install apache2 -y\n \n-sudo chown -R www-data:www-data /var/www/html\n+sudo chown -R www-data:www-data $WEBROOT\n \n \n cd $WEBROOT/\n \n"
                },
                {
                    "date": 1698266100088,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,16 +7,14 @@\n \n sudo chown -R www-data:www-data $WEBROOT\n \n \n-cd $WEBROOT/\n-\n+cd $WEBROOT\n sudo mkdir -p $SITEROOT\n cd $SITEROOT\n touch index.html\n cd ..\n \n-\n sudo echo \"<html>\" > $WEBROOT/index.html\n sudo echo \"<head>\" >> $WEBROOT/index.html\n sudo echo \"<title>Hello Word</title>\" >> $WEBROOT/index.html\n sudo echo \"</head>\" >> $WEBROOT/index.html\n"
                },
                {
                    "date": 1698266109147,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,9 +10,9 @@\n \n cd $WEBROOT\n sudo mkdir -p $SITEROOT\n cd $SITEROOT\n-touch index.html\n+touch $SITEROOT/index.html\n cd ..\n \n sudo echo \"<html>\" > $WEBROOT/index.html\n sudo echo \"<head>\" >> $WEBROOT/index.html\n"
                },
                {
                    "date": 1698266122527,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,14 +6,10 @@\n sudo apt update && sudo apt upgrade && sudo apt install apache2 -y\n \n sudo chown -R www-data:www-data $WEBROOT\n \n-\n-cd $WEBROOT\n sudo mkdir -p $SITEROOT\n-cd $SITEROOT\n touch $SITEROOT/index.html\n-cd ..\n \n sudo echo \"<html>\" > $WEBROOT/index.html\n sudo echo \"<head>\" >> $WEBROOT/index.html\n sudo echo \"<title>Hello Word</title>\" >> $WEBROOT/index.html\n"
                },
                {
                    "date": 1698266194424,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,9 +2,10 @@\n \n WEBROOT=/var/www/html\n SITEROOT=$WEBROOT/portes\n \n-sudo apt update && sudo apt upgrade && sudo apt install apache2 -y\n+sudo apt update \n+sudo apt install apache2 -y\n \n sudo chown -R www-data:www-data $WEBROOT\n \n sudo mkdir -p $SITEROOT\n"
                },
                {
                    "date": 1698266206949,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,9 +3,9 @@\n WEBROOT=/var/www/html\n SITEROOT=$WEBROOT/portes\n \n sudo apt update \n-sudo apt install apache2 -y\n+sudo apt install -y apache2\n \n sudo chown -R www-data:www-data $WEBROOT\n \n sudo mkdir -p $SITEROOT\n"
                },
                {
                    "date": 1698267075473,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -88,5 +88,13 @@\n sudo echo \"<footer>\" >> $SITEROOT/index.html\n sudo echo \"<p>&copy; 2023 Il Mio Portfolio</p>\" >> $SITEROOT/index.html\n sudo echo \"</footer>\" >> $SITEROOT/index.html\n sudo echo \"</body>\" >> $SITEROOT/index.html\n-sudo echo \"</html>\" >> $SITEROOT/index.html\n\\ No newline at end of file\n+sudo echo \"</html>\" >> $SITEROOT/index.html\n+\n+# 1- creazione index\n+# 2- chown e permessi\n+# 3- installazione apache2\n+# 4- file conf apache2 (virtualhost)\n+# 5- a2ensite nome.conf\n+# 6- systemctl reload apache2\n+# 7- systemctl restart apache2\n\\ No newline at end of file\n"
                },
                {
                    "date": 1698267336112,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,100 +1,302 @@\n-#!/usr/bin/env bash\n+#!/bin/bash\n \n-WEBROOT=/var/www/html\n-SITEROOT=$WEBROOT/portes\n+#############################################\n+#                                           #\n+#  Script di installazione di nextcloud     #\n+#                                           #\n+#############################################\n \n-sudo apt update \n-sudo apt install -y apache2\n+# Variabili di configurazione\n+#############################################\n+PHPVERSION=8.1\n+POSTGRES_VERSION=15\n+NEXTCLOUD_VERSION=27.0.2\n+NEXTCLOUD_ADMIN=admin\n+NEXTCLOUD_ADMIN_PASSWORD=admin\n+NEXTCLOUD_POSTGRES_DB=nextcloud\n+NEXTCLOUD_POSTGRES_USER=nextcloud\n+NEXTCLOUD_POSTGRES_PASSWORD=nextcloud\n+WEB_FOLDER=/usr/share/nginx/html\n+NEXTCLOUD_FOLDER=${WEB_FOLDER}/nextcloud\n+occ=\"sudo -u www-data php ${NEXTCLOUD_FOLDER}/occ\"\n+DB_POSTGRES_HOST_IP=127.0.0.1\n+DB_POSTGRES_PORT=5432\n+PROTOCOLWEB=https\n+REDIS_HOSTNAME=localhost\n+REDIS_PORT=6379\n+DOMAIN=drive.ilsverona.it\n+EMAIL=d.peruzzi@fondazioneedulife.org\n+#############################################\n \n-sudo chown -R www-data:www-data $WEBROOT\n+# Utility functions\n+#############################################\n+function doMsg(){\n+    Green=$'\\e[1;32m'\n+    White=$'\\e[0m'\n+    msg=$1\n+    echo \"${Green}\" \"${msg}\" \"${White}\"\n+}\n \n-sudo mkdir -p $SITEROOT\n-touch $SITEROOT/index.html\n+function startNginx(){\n+    case $1 in\n+        start)\n+            doMsg \"--> Configurazione servizio systemd e avvio di Nginx\"\n+            systemctl enable nginx\n+            systemctl start nginx\n+            ;;\n+        restart)\n+            doMsg \"--> Riavvio di Nginx\"\n+            systemctl restart nginx\n+            ;;\n+        stop)\n+            doMsg \"--> Arresto di Nginx\"\n+            systemctl stop nginx\n+            ;;\n+        *)\n+            doMsg \"--> Parametro non valido\"\n+            exit 1\n+            ;;\n+    esac\n+}\n+#############################################\n \n-sudo echo \"<html>\" > $WEBROOT/index.html\n-sudo echo \"<head>\" >> $WEBROOT/index.html\n-sudo echo \"<title>Hello Word</title>\" >> $WEBROOT/index.html\n-sudo echo \"</head>\" >> $WEBROOT/index.html\n-sudo echo \"<body>\" >> $WEBROOT/index.html\n-sudo echo \"<h1>Hello Word</h1>\" >> $WEBROOT/index.html\n-sudo echo \"<p>Hello Word</p>\" >> $WEBROOT/index.html\n-sudo echo \"</body>\" >> $WEBROOT/index.html\n-sudo echo \"</html>\" >> $WEBROOT/index.html\n+function installNginx(){\n+    doMsg \"--> Installo nginx e nginx-estras\"\n+    apt-get update -y\n+    doMsg \"--> Installazione nginx\"\n+    apt-get install nginx -y -qq\n+    apt-get install nginx-extras -y -qq\n+}\n \n+function installPostgres(){\n+    if [ -f /etc/apt/sources.list.d/pgdg.list ]; then\n+        doMsg \"--> La repo di postgres è già presente, non la scarico\"\n+    else\n+        doMsg \"--> Aggiungo la repo di postgres\"\n+        sh -c 'echo \"deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list'\n+        wget -qO- https://www.postgresql.org/media/keys/ACCC4CF8.asc | tee /etc/apt/trusted.gpg.d/pgdg.asc &>/dev/null\n+        apt-get update\n+    fi\n \n-sudo echo \"<html>\" > $SITEROOT/index.html\n-sudo echo \"<head>\" >> $SITEROOT/index.html\n-sudo echo \"<meta charset=\"UTF-8\">\" >> $SITEROOT/index.html\n\\ No newline at end of file\n-sudo echo \"<title>Il Mio Portfolio</title>\" >> $SITEROOT/index.html\n-sudo echo \"<style>\" >> $SITEROOT/index.html\n-sudo echo \"body {\" >> $SITEROOT/index.html\n-sudo echo \"font-family: Arial, sans-serif;\" >> $SITEROOT/index.html\n-sudo echo \"background-color: #f4f4f4;\" >> $SITEROOT/index.html\n-sudo echo \"margin: 0;\" >> $SITEROOT/index.html\n-sudo echo \"padding: 0;\" >> $SITEROOT/index.html\n-sudo echo \"}\" >> $SITEROOT/index.html\n-sudo echo \"header {\" >> $SITEROOT/index.html\n-sudo echo \"background-color: #333;\" >> $SITEROOT/index.html\n-sudo echo \"color: #fff;\" >> $SITEROOT/index.html\n-sudo echo \"text-align: center;\" >> $SITEROOT/index.html\n-sudo echo \"padding: 20px 0;\" >> $SITEROOT/index.html\n-sudo echo \"}\" >> $SITEROOT/index.html\n-sudo echo \"h1 {\" >> $SITEROOT/index.html\n-sudo echo \"font-size: 2em;\" >> $SITEROOT/index.html\n-sudo echo \"}\" >> $SITEROOT/index.html\n-sudo echo \"section {\" >> $SITEROOT/index.html\n-sudo echo \"max-width: 800px;\" >> $SITEROOT/index.html\n-sudo echo \"margin: 20px auto;\" >> $SITEROOT/index.html\n-sudo echo \"padding: 20px;\" >> $SITEROOT/index.html\n-sudo echo \"background-color: #fff;\" >> $SITEROOT/index.html\n-sudo echo \"}\" >> $SITEROOT/index.html\n-sudo echo \"h2 {\" >> $SITEROOT/index.html\n-sudo echo \"font-size: 1.5em;\" >> $SITEROOT/index.html\n-sudo echo \"}\" >> $SITEROOT/index.html\n-sudo echo \"p {\" >> $SITEROOT/index.html\n-sudo echo \"font-size: 1.2em;\" >> $SITEROOT/index.html\n-sudo echo \"}\" >> $SITEROOT/index.html\n-sudo echo \".project {\" >> $SITEROOT/index.html\n-sudo echo \"margin-bottom: 20px;\" >> $SITEROOT/index.html\n-sudo echo \"}\" >> $SITEROOT/index.html\n-sudo echo \"footer {\" >> $SITEROOT/index.html\n-sudo echo \"background-color: #333;\" >> $SITEROOT/index.html\n-sudo echo \"color: #fff;\" >> $SITEROOT/index.html\n-sudo echo \"text-align: center;\" >> $SITEROOT/index.html\n-sudo echo \"padding: 10px 0;\" >> $SITEROOT/index.html\n-sudo echo \"}\" >> $SITEROOT/index.html\n-sudo echo \"</style>\" >> $SITEROOT/index.html\n-sudo echo \"</head>\" >> $SITEROOT/index.html\n-sudo echo \"<body>\" >> $SITEROOT/index.html\n-sudo echo \"<header>\" >> $SITEROOT/index.html\n-sudo echo \"<h1>Il Mio Portfolio</h1>\" >> $SITEROOT/index.html\n-sudo echo \"<p>Benvenuto nel mio portfolio personale</p>\" >> $SITEROOT/index.html\n-sudo echo \"</header>\" >> $SITEROOT/index.html\n-sudo echo \"<section>\" >> $SITEROOT/index.html\n-sudo echo \"<h2>Chi Sono</h2>\" >> $SITEROOT/index.html\n-sudo echo \"<p>Ciao, sono [Il Tuo Nome]. Sono uno sviluppatore web appassionato di progettazione e sviluppo di siti web creativi e coinvolgenti.</p>\" >> $SITEROOT/index.html\n-sudo echo \"</section>\" >> $SITEROOT/index.html\n-sudo echo \"<section>\" >> $SITEROOT/index.html\n-sudo echo \"<h2>I Miei Progetti</h2>\" >> $SITEROOT/index.html\n-sudo echo \"<div class=\"project\">\" >> $SITEROOT/index.html\n-sudo echo \"<h3>Progetto 1</h3>\" >> $SITEROOT/index.html\n-sudo echo \"<p>Descrizione del primo progetto. Qui puoi scrivere di più sui dettagli e le tecnologie utilizzate.</p>\" >> $SITEROOT/index.html\n-sudo echo \"</div>\" >> $SITEROOT/index.html\n-sudo echo \"<div class=\"project\">\" >> $SITEROOT/index.html\n-sudo echo \"<h3>Progetto 2</h3>\" >> $SITEROOT/index.html\n-sudo echo \"<p>Descrizione del secondo progetto. Puoi anche includere collegamenti ai progetti se desideri.</p>\" >> $SITEROOT/index.html\n-sudo echo \"</div>\" >> $SITEROOT/index.html\n-sudo echo \"</section>\" >> $SITEROOT/index.html\n-sudo echo \"<footer>\" >> $SITEROOT/index.html\n-sudo echo \"<p>&copy; 2023 Il Mio Portfolio</p>\" >> $SITEROOT/index.html\n-sudo echo \"</footer>\" >> $SITEROOT/index.html\n-sudo echo \"</body>\" >> $SITEROOT/index.html\n-sudo echo \"</html>\" >> $SITEROOT/index.html\n+    if [ $(apt list | grep installed | postgresql | wc -l) -gt 0 ]; then\n+        doMsg \"--> Postgresql è già installato\"\n+    else\n+        doMsg \"--> Installo postgresql\"\n+        apt-get install postgresql-${POSTGRES_VERSION} postgresql-client-${POSTGRES_VERSION} -y\n+    fi\n \n-# 1- creazione index\n-# 2- chown e permessi\n-# 3- installazione apache2\n-# 4- file conf apache2 (virtualhost)\n-# 5- a2ensite nome.conf\n-# 6- systemctl reload apache2\n-# 7- systemctl restart apache2\n+    doMsg \"--> Avvio postgresql ${POSTGRES_VERSION}\"\n+    systemctl start postgresql\n+}\n+\n+function configureDatabase(){\n+    doMsg \"--> Configuro il database\"\n+    sudo -u postgres psql <<END\n+    CREATE USER ${NEXTCLOUD_POSTGRES_USER} WITH PASSWORD '${NEXTCLOUD_POSTGRES_PASSWORD}';\n+    CREATE DATABASE ${NEXTCLOUD_POSTGRES_DB} TEMPLATE template0 ENCODING 'UNICODE';\n+    ALTER DATABASE ${NEXTCLOUD_POSTGRES_DB} OWNER TO ${NEXTCLOUD_POSTGRES_USER};\n+    GRANT ALL PRIVILEGES ON DATABASE ${NEXTCLOUD_POSTGRES_DB} TO ${NEXTCLOUD_POSTGRES_USER};\n+    GRANT CREATE ON SCHEMA public to ${NEXTCLOUD_POSTGRES_USER};\n+END\n+}\n+\n+function installRedis(){\n+    REDISCONFIGFILE=/etc/redis/redis.conf\n+    if [ -f ${REDISCONFIGFILE} ]; then\n+        doMsg \"--> Redis è già installato\"\n+    else\n+        doMsg \"--> Installo redis\"\n+        apt-get install redis-server -y -qq\n+        sed '/#ADDCUSTOM/,$d' ${REDISCONFIGFILE} > ${REDISCONFIGFILE}.new\n+        mv ${REDISCONFIGFILE} ${REDISCONFIGFILE}.old\n+        mv ${REDISCONFIGFILE}.new ${REDISCONFIGFILE}\n+        echo \"#ADDCUSTOM\" >> ${REDISCONFIGFILE}\n+        echo \"bind 127.0.0.1 ::1\" >> ${REDISCONFIGFILE}\n+    fi\n+    \n+    systemctl restart redis\n+}\n+\n+function installDep(){\n+    doMsg \"--> Installo le dipendenze\"\n+    apt-get install curl gnupg2 gnupg openssl ca-certificates lsb-release ubuntu-keyring unzip -y -qq\n+    apt-get install php${PHPVERSION} php${PHPVERSION}-fpm php${PHPVERSION}-gd php${PHPVERSION}-pgsql php${PHPVERSION}-curl \\\n+        php${PHPVERSION}-mbstring php${PHPVERSION}-intl php-apcu \\\n+        php${PHPVERSION}-gmp php${PHPVERSION}-bcmath php-imagick php${PHPVERSION}-xml php-redis php${PHPVERSION}-zip unzip libmagickcore-6.q16-3-extra \\\n+        php${PHPVERSION}-memcached php${PHPVERSION}-memcache -y -qq\n+}\n+\n+function downloadNC(){\n+    wget -O nextcloud-${NEXTCLOUD_VERSION}.zip https://download.nextcloud.com/server/releases/nextcloud-${NEXTCLOUD_VERSION}.zip\n+    md5sum nextcloud-${NEXTCLOUD_VERSION}.zip > nextcloud.md5\n+}\n+\n+function getNC(){\n+    doMsg \"--> Scarico la versione di nextcloud ${NEXTCLOUD_VERSION}\"\n+    cd $WEB_FOLDER\n+    if [ ! -f nextcloud.md5 ]; then\n+        downloadNC\n+    else\n+        md5sum -c nextcloud.md5\n+        if [ ! $? -eq 0 ]; then\n+            doMsg \"--> Pacchetto ${NEXTCLOUD_VERSION} già presente ma checksum cambiato, lo riscarico\"\n+            downloadNC\n+        else\n+            doMsg \"--> Il pacchetto ${NEXTCLOUD_VERSION} è già presente, non lo scarico\"\n+        fi\n+    fi\n+    cd $WEB_FOLDER/\n+    unzip -q -o nextcloud-${NEXTCLOUD_VERSION}.zip\n+}\n+\n+\n+function configureNginx(){\n+    doMsg \"--> Applico la configurazione di nginx\"\n+    sed -i 's/user  nginx;/user  www-data;/' /etc/nginx/nginx.conf\n+    cp /app/scripts/nextcloud.conf /etc/nginx/conf.d/\n+    if [ -f /etc/nginx/conf.d/default.conf ]; then\n+        mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.disabled\n+    fi\n+    if [ -f /etc/nginx/sites-enabled/default ]; then\n+        rm /etc/nginx/sites-enabled/default\n+    fi\n+}\n+\n+function configureNextcloud(){\n+    doMsg \"--> Controllo i permessi della cartella di setup\"\n+    chown -R www-data:www-data ${NEXTCLOUD_FOLDER}\n+\n+    doMsg \"--> Installo Nextcloud\"\n+    $occ maintenance:install --database \\\n+    \"pgsql\" --database-name \"${NEXTCLOUD_POSTGRES_DB}\"  --database-user \"${NEXTCLOUD_POSTGRES_USER}\" --database-pass \\\n+    \"${NEXTCLOUD_POSTGRES_PASSWORD}\" --database-host ${DB_POSTGRES_HOST_IP} --database-port ${DB_POSTGRES_PORT} --admin-user \\\n+    \"${NEXTCLOUD_ADMIN}\" --admin-pass \"${NEXTCLOUD_ADMIN_PASSWORD}\"\n+\n+    if [ $? -eq 0 ]; then\n+        doMsg \"--> Nextcloud installato correttamente\"\n+    else\n+        doMsg \"--> Errore durante l'installazione di Nextcloud\"\n+        exit 1\n+    fi\n+    \n+    chmod +x ${NEXTCLOUD_FOLDER}/occ\n+    $occ config:system:set overwriteprotocol --value \"${PROTOCOLWEB}\"\n+    $occ config:system:set trusted_domains 1 --value \"${DOMAIN}\"\n+    #pulisce dal cestino gli oggetti più vecchi di 30 giorni e quando serve spazio\n+    $occ config:system:set trashbin_retention_obligation --value '30,auto'\n+    #Tiene le versioni dei file per 365 giorni, poi le imposta in stato expired e le tiene per altri 30 giorni\n+    $occ config:system:set versions_retention_obligation --value '365,30'\n+    $occ config:system:set htaccess.RewriteBase --value /\n+    $occ maintenance:update:htaccess #enabled pretty urls\n+    $occ config:system:set filelocking.enabled  --value=true\n+    $occ config:system:set redis host --value=\"${REDIS_HOSTNAME}\"\n+    $occ config:system:set redis port --value=\"${REDIS_PORT}\" --type=integer\n+    $occ config:system:set 'memcache.local' --value='\\OC\\Memcache\\Redis'\n+    $occ config:system:set 'memcache.distributed' --value='\\OC\\Memcache\\Redis'\n+    $occ config:system:set 'memcache.locking' --value='\\OC\\Memcache\\Redis'\n+\n+    #ogni altra configurazione utile è qui https://docs.nextcloud.com/server/19/admin_manual/configuration_server/config_sample_php_parameters.html?highlight=overwrite%20cli%20url\n+    chown -R www-data:www-data ${NEXTCLOUD_FOLDER}/config\n+    chmod -R 755 ${NEXTCLOUD_FOLDER}/config\n+    chmod 650 ${NEXTCLOUD_FOLDER}/config/*\n+}\n+\n+function configureNginxCache(){\n+    doMsg \"--> Configurazione delle ottimizzazioni per la cache\"\n+\n+    chmod -R 755 $NEXTCLOUD_FOLDER/config\n+\n+    export php_max_time=3600\n+    export php_memory_limit=512M\n+    export php_upload_limit=10G\n+\n+    cli_destination=\"/etc/php/${PHPVERSION}/cli/php.ini\"\n+    php_fpm_file=\"/etc/php/${PHPVERSION}/fpm/php.ini\"\n+    www_fpm_config=\"/etc/php/${PHPVERSION}/fpm/pool.d/www.conf\"\n+    if [ ! -f \"${cli_destination}.back\" ]; then\n+        cp -f \"${cli_destination}\" \"${cli_destination}.back\"\n+    else\n+        cp -f \"${cli_destination}.back\" \"${cli_destination}\"\n+    fi\n+    if [ ! -f \"${php_fpm_file}.back\" ]; then\n+        cp -f \"${php_fpm_file}\" \"${php_fpm_file}.back\"\n+    else\n+        cp -f \"${php_fpm_file}.back\" \"${php_fpm_file}\"\n+    fi\n+    if [ ! -f \"${www_fpm_config}.back\" ]; then\n+        cp -f \"${www_fpm_config}\" \"${www_fpm_config}.back\"\n+    else\n+        cp -f \"${www_fpm_config}.back\" \"${www_fpm_config}\" \n+    fi\n+    \n+    cd $NEXTCLOUD_FOLDER\n+\n+    sed -i -e \"s/memory_limit\\s*=.*/memory_limit = ${php_memory_limit}/g\" \\\n+        -e \"s/upload_max_filesize\\s*=.*/upload_max_filesize = ${php_upload_limit}/g\" \\\n+        -e \"s/post_max_size\\s*=.*/post_max_size = ${php_upload_limit}/g\" \\\n+        -e \"s/Max_execution_time\\s*=.*/max_execution_time = ${php_max_time}/g\" \\\n+        -e \"s/max_input_time\\s*=.*/max_input_time = ${php_max_time}/g\" \\\n+        -e \"s/;?opcache\\.save_comments=[^=]*/opcache.save_comments=1/\" \\\n+        -e \"s/;?opcache\\.revalidate_freq=[^=]*/opcache.revalidate_freq=60/\" \\\n+        -e \"s/;?opcache\\.memory_consumption=[^=]*/opcache.memory_consumption=64/\" \\\n+        -e \"s/;?opcache\\.interned_strings_buffer=[^=]*/opcache.interned_strings_buffer=32/\" \\\n+    \"${cli_destination}\"\n+\n+    sed -i -e \"s/memory_limit\\s*=.*/memory_limit = ${php_memory_limit}/g\" \\\n+        -e \"s/upload_max_filesize\\s*=.*/upload_max_filesize = ${php_upload_limit}/g\" \\\n+        -e \"s/post_max_size\\s*=.*/post_max_size = ${php_upload_limit}/g\" \\\n+        -e \"s/Max_execution_time\\s*=.*/max_execution_time = ${php_max_time}/g\" \\\n+        -e \"s/max_input_time\\s*=.*/max_input_time = ${php_max_time}/g\" \\\n+        -e \"s/;?opcache\\.save_comments=[^=]*/opcache.save_comments=1/\" \\\n+        -e \"s/;?opcache\\.revalidate_freq=[^=]*/opcache.revalidate_freq=60/\" \\\n+        -e \"s/;?opcache\\.memory_consumption=[^=]*/opcache.memory_consumption=64/\" \\\n+        -e \"s/;?opcache\\.interned_strings_buffer=[^=]*/opcache.interned_strings_buffer=32/\" \\\n+    \"${php_fpm_file}\"\n+\n+    sed -i -e '/clear_env/ s/^.//' ${www_fpm_config}\n+    sed -i -e '/env\\[/ s/^.//'  ${www_fpm_config}\n+\n+    echo apc.enable_cli=1 >> \"${cli_destination}\" \n+\n+    doMsg \"--> Applico le modifiche php\"\n+    systemctl restart php${PHPVERSION}-fpm\n+}\n+\n+function installCertbot(){\n+    doMsg \"--> Installo certbot\"\n+    apt-get install certbot python3-certbot-nginx -y -qq\n+}\n+\n+function installCert(){\n+    doMsg \"--> Installo il certificato\"\n+    certbot certonly --standalone -d ${DOMAIN} -m ${EMAIL} --agree-tos --non-interactive\n+}\n+\n+function customizingNextcloud(){\n+    doMsg \"--> Configurazione di personalizzazioni utente\"\n+    $occ config:system:set default_phone_region --value=IT\n+    $occ config:system:set default_phone_region --value IT\n+    $occ config:system:set default_locale --value it_IT\n+    $occ config:system:set enforce_locale --value it_IT\n+    $occ config:system:set default_language --value it\n+    $occ config:system:set enforce_language --value it\n+    $occ config:system:set skeletondirectory --value \"\"\n+}\n+\n+# Main\n+#############################################\n+installNginx\n+startNginx start\n+installDep\n+installPostgres\n+configureDatabase\n+installRedis\n+configureNginx\n+getNC\n+configureNextcloud\n+configureNginxCache\n+installCertbot\n+installCert\n+startNginx restart\n+#customizingNextcloud\n+#############################################\n"
                },
                {
                    "date": 1698315045437,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -295,8 +295,9 @@\n getNC\n configureNextcloud\n configureNginxCache\n installCertbot\n+startNginx stop\n installCert\n startNginx restart\n #customizingNextcloud\n #############################################\n"
                }
            ],
            "date": 1698242128453,
            "name": "Commit-0",
            "content": "#!/bin/bash\n\n#############################################\n#                                           #\n#  Script di installazione di nextcloud     #\n#                                           #\n#############################################\n\n# Variabili di configurazione\n#############################################\nPHPVERSION=8.1\nPOSTGRES_VERSION=15\nNEXTCLOUD_VERSION=27.0.2\nNEXTCLOUD_ADMIN=admin\nNEXTCLOUD_ADMIN_PASSWORD=admin\nNEXTCLOUD_POSTGRES_DB=nextcloud\nNEXTCLOUD_POSTGRES_USER=nextcloud\nNEXTCLOUD_POSTGRES_PASSWORD=nextcloud\nWEB_FOLDER=/usr/share/nginx/html\nNEXTCLOUD_FOLDER=${WEB_FOLDER}/nextcloud\nocc=\"sudo -u www-data php ${NEXTCLOUD_FOLDER}/occ\"\nDB_POSTGRES_HOST_IP=127.0.0.1\nDB_POSTGRES_HOST_IP=5432\nPROTOCOLWEB=http\nREDIS_HOSTNAME=localhost\nREDIS_PORT=6379\n#############################################\nfunction doMsg(){\n    Green=$'\\e[1;32m'\n    White=$'\\e[0m'\n    msg=$1\n    echo \"${Green}\" \"${msg}\" \"${White}\"\n}\n\nfunction installNginx(){\n    doMsg \"--> Installo nginx e nginx-estras\"\n    apt-get update -y\n    doMsg \"--> Installazione nginx\"\n    apt-get install nginx -y -qq\n    apt-get install nginx-extras -y -qq\n}\n\nfunction startNginx(){\n    case $1 in\n        start)\n            doMsg \"--> Configurazione servizio systemd e avvio di Nginx\"\n            systemctl enable nginx\n            systemctl start nginx\n            ;;\n        restart)\n            doMsg \"--> Riavvio di Nginx\"\n            systemctl restart nginx\n            ;;\n        stop)\n            doMsg \"--> Arresto di Nginx\"\n            systemctl stop nginx\n            ;;\n        *)\n            doMsg \"--> Parametro non valido\"\n            exit 1\n            ;;\n    esac\n}\n\nfunction installPostgres(){\n    sh -c 'echo \"deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list'\n    wget -qO- https://www.postgresql.org/media/keys/ACCC4CF8.asc | tee /etc/apt/trusted.gpg.d/pgdg.asc &>/dev/null\n    apt-get update\n\n    doMsg \"--> Installo postgresql ${POSTGRES_VERSION}\"\n    apt-get install postgresql-${POSTGRES_VERSION} postgresql-client-${POSTGRES_VERSION} -y\n\n    doMsg \"--> Avvio postgresql ${POSTGRES_VERSION}\"\n    systemctl start postgresql\n}\n\nfunction configureDatabase(){\n    doMsg \"--> Configuro il database\"\n    sudo -u postgres psql <<END\n    CREATE USER ${NEXTCLOUD_POSTGRES_USER} WITH PASSWORD '${NEXTCLOUD_POSTGRES_PASSWORD}';\n    CREATE DATABASE ${NEXTCLOUD_POSTGRES_DB} TEMPLATE template0 ENCODING 'UNICODE';\n    ALTER DATABASE ${NEXTCLOUD_POSTGRES_DB} OWNER TO ${NEXTCLOUD_POSTGRES_USER};\n    GRANT ALL PRIVILEGES ON DATABASE ${NEXTCLOUD_POSTGRES_DB} TO ${NEXTCLOUD_POSTGRES_USER};\n    GRANT CREATE ON SCHEMA public to ${NEXTCLOUD_POSTGRES_USER};\nEND\n}\n\nfunction installRedis(){\n    doMsg \"--> Installo redis\"\n    REDISCONFIGFILE=/etc/redis/redis.conf\n    apt-get install redis-server -y -qq\n    sed '/#ADDCUSTOM/,$d' ${REDISCONFIGFILE} > ${REDISCONFIGFILE}.new\n    mv ${REDISCONFIGFILE} ${REDISCONFIGFILE}.old\n    mv ${REDISCONFIGFILE}.new ${REDISCONFIGFILE}\n    echo \"#ADDCUSTOM\" >> ${REDISCONFIGFILE}\n    echo \"bind 127.0.0.1 ::1\" >> ${REDISCONFIGFILE}\n    systemctl restart redis\n}\n\nfunction installDep(){\n    doMsg \"--> Installo le dipendenze\"\n    apt-get install curl gnupg2 gnupg openssl ca-certificates lsb-release ubuntu-keyring unzip -y -qq\n    apt-get install php${PHPVERSION} php${PHPVERSION}-fpm php${PHPVERSION}-gd php${PHPVERSION}-pgsql php${PHPVERSION}-curl \\\n        php${PHPVERSION}-mbstring php${PHPVERSION}-intl php-apcu \\\n        php${PHPVERSION}-gmp php${PHPVERSION}-bcmath php-imagick php${PHPVERSION}-xml php-redis php${PHPVERSION}-zip unzip libmagickcore-6.q16-3-extra \\\n        php${PHPVERSION}-memcached php${PHPVERSION}-memcache -y -qq\n}\n\nfunction downloadNC(){\n    wget -O nextcloud-${NEXTCLOUD_VERSION}.zip https://download.nextcloud.com/server/releases/nextcloud-${NEXTCLOUD_VERSION}.zip\n    md5sum nextcloud-${NEXTCLOUD_VERSION}.zip > nextcloud.md5\n}\n\nfunction getNC(){\n    doMsg \"--> Scarico la versione di nextcloud ${NEXTCLOUD_VERSION}\"\n    cd $WEB_FOLDER\n    if [ ! -f nextcloud.md5 ]; then\n        downloadNC\n    else\n        md5sum -c nextcloud.md5\n        if [ ! $? -eq 0 ]; then\n            doMsg \"--> Pacchetto ${NEXTCLOUD_VERSION} già presente ma checksum cambiato, lo riscarico\"\n            downloadNC\n        else\n            doMsg \"--> Il pacchetto ${NEXTCLOUD_VERSION} è già presente, non lo scarico\"\n        fi\n    fi\n    cd $WEB_FOLDER/\n    unzip -q -o nextcloud-${NEXTCLOUD_VERSION}.zip\n}\n\n\nfunction configureNginx(){\n    sed -i 's/user  nginx;/user  www-data;/' /etc/nginx/nginx.conf\n    cp /data/nextcloud.conf /etc/nginx/conf.d/\n    if [ -f /etc/nginx/conf.d/default.conf ]; then\n        mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.disabled\n    fi\n    if [ -f /etc/nginx/sites-enabled/default ]; then\n        rm /etc/nginx/sites-enabled/default\n    fi\n}\n\nfunction configureNextcloud(){\n    doMsg \"--> Controlla permessi cartella di setup\"\n    chown -R www-data:www-data ${NEXTCLOUD_FOLDER}\n\n    doMsg \"--> Installo Nextcloud\"\n    $occ maintenance:install --database \\\n    \"pgsql\" --database-name \"${NEXTCLOUD_POSTGRES_DB}\"  --database-user \"${NEXTCLOUD_POSTGRES_USER}\" --database-pass \\\n    \"${NEXTCLOUD_POSTGRES_PASSWORD}\" --database-host ${DB_POSTGRES_HOST_IP} --database-port ${DB_POSTGRES_PORT} --admin-user \\\n    \"${NEXTCLOUD_ADMIN}\" --admin-pass \"${NEXTCLOUD_ADMIN_PASSWORD}\" --data-dir \"/nfs4/www/data\"\n\n    \n    chmod +x ${NEXTCLOUD_FOLDER}/occ\n    $occ config:system:set overwriteprotocol --value \"${PROTOCOLWEB}\"\n    #pulisce dal cestino gli oggetti più vecchi di 30 giorni e quando serve spazio\n    $occ config:system:set trashbin_retention_obligation --value '30,auto'\n    #Tiene le versioni dei file per 365 giorni, poi le imposta in stato expired e le tiene per altri 30 giorni\n    $occ config:system:set versions_retention_obligation --value '365,30'\n    $occ config:system:set htaccess.RewriteBase --value /\n    $occ maintenance:update:htaccess #enabled pretty urls\n    $occ config:system:set filelocking.enabled  --value=true\n    $occ config:system:set redis host --value=\"${REDIS_HOSTNAME}\"\n    $occ config:system:set redis port --value=\"${REDIS_PORT}\" --type=integer\n    $occ config:system:set 'memcache.local' --value='\\OC\\Memcache\\APCu'\n    $occ config:system:set 'memcache.distributed' --value='\\OC\\Memcache\\Redis'\n    $occ config:system:set 'memcache.locking' --value='\\OC\\Memcache\\Redis'\n\n    #ogni altra configurazione utile è qui https://docs.nextcloud.com/server/19/admin_manual/configuration_server/config_sample_php_parameters.html?highlight=overwrite%20cli%20url\n    chown -R www-data:www-data ${NEXTCLOUD_FOLDER}/config\n    chmod -R 755 ${NEXTCLOUD_FOLDER}/config\n    chmod 650 ${NEXTCLOUD_FOLDER}/config/*\n}\n\nfunction configureNginxCache(){\n    doMsg \"--> Configurazione delle ottimizzazioni per la cache\"\n\n    chmod -R 755 $NEXTCLOUD_FOLDER/config\n\n    export php_max_time=3600\n    export php_memory_limit=512M\n    export php_upload_limit=10G\n\n    cli_destination=\"/etc/php/${PHPVERSION}/cli/php.ini\"\n    php_fpm_file=\"/etc/php/${PHPVERSION}/fpm/php.ini\"\n    www_fpm_config=\"/etc/php/${PHPVERSION}/fpm/pool.d/www.conf\"\n    if [ ! -f \"${cli_destination}.back\" ]; then\n        cp -f \"${cli_destination}\" \"${cli_destination}.back\"\n    else\n        cp -f \"${cli_destination}.back\" \"${cli_destination}\"\n    fi\n    if [ ! -f \"${php_fpm_file}.back\" ]; then\n        cp -f \"${php_fpm_file}\" \"${php_fpm_file}.back\"\n    else\n        cp -f \"${php_fpm_file}.back\" \"${php_fpm_file}\"\n    fi\n    if [ ! -f \"${www_fpm_config}.back\" ]; then\n        cp -f \"${www_fpm_config}\" \"${www_fpm_config}.back\"\n    else\n        cp -f \"${www_fpm_config}.back\" \"${www_fpm_config}\" \n    fi\n    \n    cd $NEXTCLOUD_FOLDER\n\n    sed -i -e \"s/memory_limit\\s*=.*/memory_limit = ${php_memory_limit}/g\" \\\n        -e \"s/upload_max_filesize\\s*=.*/upload_max_filesize = ${php_upload_limit}/g\" \\\n        -e \"s/post_max_size\\s*=.*/post_max_size = ${php_upload_limit}/g\" \\\n        -e \"s/Max_execution_time\\s*=.*/max_execution_time = ${php_max_time}/g\" \\\n        -e \"s/max_input_time\\s*=.*/max_input_time = ${php_max_time}/g\" \\\n        -e \"s/;?opcache\\.save_comments=[^=]*/opcache.save_comments=1/\" \\\n        -e \"s/;?opcache\\.revalidate_freq=[^=]*/opcache.revalidate_freq=60/\" \\\n        -e \"s/;?opcache\\.memory_consumption=[^=]*/opcache.memory_consumption=64/\" \\\n        -e \"s/;?opcache\\.interned_strings_buffer=[^=]*/opcache.interned_strings_buffer=32/\" \\\n    \"${cli_destination}\"\n\n    sed -i -e \"s/memory_limit\\s*=.*/memory_limit = ${php_memory_limit}/g\" \\\n        -e \"s/upload_max_filesize\\s*=.*/upload_max_filesize = ${php_upload_limit}/g\" \\\n        -e \"s/post_max_size\\s*=.*/post_max_size = ${php_upload_limit}/g\" \\\n        -e \"s/Max_execution_time\\s*=.*/max_execution_time = ${php_max_time}/g\" \\\n        -e \"s/max_input_time\\s*=.*/max_input_time = ${php_max_time}/g\" \\\n        -e \"s/;?opcache\\.save_comments=[^=]*/opcache.save_comments=1/\" \\\n        -e \"s/;?opcache\\.revalidate_freq=[^=]*/opcache.revalidate_freq=60/\" \\\n        -e \"s/;?opcache\\.memory_consumption=[^=]*/opcache.memory_consumption=64/\" \\\n        -e \"s/;?opcache\\.interned_strings_buffer=[^=]*/opcache.interned_strings_buffer=32/\" \\\n    \"${php_fpm_file}\"\n\n    sed -i -e '/clear_env/ s/^.//' ${www_fpm_config}\n    sed -i -e '/env\\[/ s/^.//'  ${www_fpm_config}\n\n    echo apc.enable_cli=1 >> \"${cli_destination}\" \n\n    doMsg \"--> Applico le modifiche php\"\n    systemctl restart php${PHPVERSION}-fpm\n    systemctl restart nginx\n}\n\n\nfunction customizingNextcloud(){\n    doMsg \"--> Configurazione di personalizzazioni utente\"\n    $occ config:system:set default_phone_region --value=IT\n    $occ config:system:set default_phone_region --value IT\n    $occ config:system:set default_locale --value it_IT\n    $occ config:system:set enforce_locale --value it_IT\n    $occ config:system:set default_language --value it\n    $occ config:system:set enforce_language --value it\n    $occ config:system:set skeletondirectory --value \"\"\n}\n\n\ninstallNginx\nstartNginx start\ninstallDep\nstartNginx restart\ninstallPostgres\nconfigureDatabase\ninstallRedis\nconfigureNginx\nconfigureNginxCache\ngetNC\nconfigureNextcloud\n#customizingNextcloud\n"
        }
    ]
}